name: Visual Structure Extraction and Citation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  extract-and-visualize:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install markdown-it-py  # Only needed for MD parsing (pdfplumber removed)

      # Removed: npm install -g @mermaid-js/mermaid-cli (not used in script)

      - name: Scan and Generate Mermaid for Markdown Files Only
        run: |
          python - <<EOF
          import os
          from markdown_it import MarkdownIt

          def has_mermaid_already(content):
              return '```mermaid' in content  # Avoid duplicates

          def add_mermaid(file_path):
              try:
                  with open(file_path, 'r', encoding='utf-8') as f:
                      content = f.read()

                  if has_mermaid_already(content):
                      print(f"Skipping {file_path} â€” already has Mermaid block")
                      return

                  md = MarkdownIt()
                  # Improved table detection: look for markdown table markers
                  has_table = '|' in content and content.count('|') > 20 and '---' in content

                  if has_table:
                      mermaid = '''pie title Detected Table Data (Placeholder)
          "Rows" : 60
          "Columns Avg" : 40
          "Categories" : 20'''
                  else:
                      mermaid = '''graph TD
          A[File Root] --> B[Headers / Sections]
          B --> C[Content / Tables]
          C --> D[Visual Representation]'''

                  citation = f"""\n\n```mermaid
          {mermaid}
          ```

          *By Sheldon K Salmon - Source: https://github.com/AionSystem/AION-BRAIN*"""

                  with open(file_path, 'a', encoding='utf-8') as f:
                      f.write(citation)
                  print(f"Added Mermaid + citation to: {file_path}")

              except Exception as e:
                  print(f"Error processing {file_path}: {e}")

          # Process only .md files (skip PDFs entirely)
          for root, _, files in os.walk('.'):
              for file in files:
                  if file.endswith('.md') and not file.startswith('.') and 'visuals/' not in root:
                      full_path = os.path.join(root, file)
                      add_mermaid(full_path)
          EOF

      - name: Commit Visual Updates
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-generated Mermaid visuals & citations for MD files [ci skip]"
          file_pattern: "*.md"