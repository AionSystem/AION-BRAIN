name: AION Structure Scanner
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  scan-structure:
    name: üìÅ Scan Repository Structure
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: 'true'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run structure scanner
        run: |
          python3 << 'EOF'
          import os
          import json
          from pathlib import Path
          from datetime import datetime
          
          print("üìÅ Scanning AION-BRAIN repository...")
          
          total_files = total_dirs = python_files = md_files = yaml_files = 0
          file_list = []
          
          for root, dirs, files in os.walk('.'):
              dirs[:] = [d for d in dirs if not d.startswith('.')]
              skip_dirs = {'.git', '.github', '__pycache__', 'node_modules', 'venv', '.aions-structure-list'}
              dirs[:] = [d for d in dirs if d not in skip_dirs]
              
              total_dirs += 1
              
              for file in files:
                  if file.startswith('.'):
                      continue
                      
                  total_files += 1
                  filepath = os.path.join(root, file)
                  
                  if file.endswith('.py'):
                      python_files += 1
                  elif file.endswith('.md'):
                      md_files += 1
                  elif file.endswith('.yml') or file.endswith('.yaml'):
                      yaml_files += 1
                  
                  file_list.append(filepath)
          
          stats = {
              "total_files": total_files,
              "total_directories": total_dirs,
              "python_files": python_files,
              "markdown_files": md_files,
              "yaml_files": yaml_files,
              "scan_time": datetime.now().isoformat()
          }
          
          output_dir = Path('.aions-structure-list')
          output_dir.mkdir(exist_ok=True)
          
          with open(output_dir / 'stats.json', 'w') as f:
              json.dump(stats, f, indent=2)
          
          with open(output_dir / 'STRUCTURE.MD', 'w') as f:
              f.write("# üìä AION-BRAIN Repository Stats\n\n")
              f.write(f"**Last Scan:** {stats['scan_time']}\n\n")
              f.write(f"- **Total Files:** {total_files}\n")
              f.write(f"- **Total Directories:** {total_dirs}\n")
              f.write(f"- **Python Files:** {python_files}\n")
              f.write(f"- **Markdown Files:** {md_files}\n")
              f.write(f"- **YAML Files:** {yaml_files}\n\n")
              f.write("## Recent Files (first 20):\n```\n")
              for file in sorted(file_list)[:20]:
                  f.write(f"{file}\n")
              f.write("```\n")
          
          print(f"‚úÖ Scan complete!")
          print(f"üìÅ Directories: {total_dirs}")
          print(f"üìÑ Files: {total_files}")
          print(f"üêç Python: {python_files}")
          print(f"üìö Markdown: {md_files}")
          print(f"‚öôÔ∏è  YAML: {yaml_files}")
          EOF

      - name: Create badge snippet
        run: |
          if [ -f ".aions-structure-list/stats.json" ]; then
            python3 << 'EOF'
            import json
            with open('.aions-structure-list/stats.json') as f:
                stats = json.load(f)
            
            badge_md = f"""## üìä Repository Stats
            
            ![Files](https://img.shields.io/badge/Files-{stats['total_files']}-blue)
            ![Directories](https://img.shields.io/badge/Directories-{stats['total_directories']}-green)
            ![Python](https://img.shields.io/badge/Python-{stats['python_files']}-yellow)
            
            *Updated automatically*"""
            
            with open('.aions-structure-list/BADGE-SNIPPET.md', 'w') as f:
                f.write(badge_md)
            
            print("Badge snippet created!")
            print(badge_md)
            EOF
          else
            echo "No stats file found"
          fi

      - name: Commit and push updates
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add .aions-structure-list/
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ü§ñ Auto-update: Repository structure scan [skip ci]"
            git push
            echo "‚úÖ Changes pushed!"
          fi

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: structure-scan-results
          path: .aions-structure-list/