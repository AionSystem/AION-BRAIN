name: Visual Structure Extraction and Citation (MD Only)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  extract-and-visualize:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: python -m pip install --upgrade pip markdown-it-py

      - name: Generate Mermaid for Markdown Files
        run: |
          set -euo pipefail

          # Write Python script to file (avoids heredoc indent issues)
          cat > generate_mermaid.py <<'END_SCRIPT'
import os
from markdown_it import MarkdownIt

def has_mermaid_already(content):
    return '```mermaid' in content.lower()

def add_mermaid(file_path):
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()

        if has_mermaid_already(content):
            print(f"SKIP (already has Mermaid): {file_path}")
            return

        md = MarkdownIt()
        has_table = '|' in content and '---' in content and content.count('|') > 20

        if has_table:
            mermaid = """pie title Detected Table (Placeholder)
"Rows" : 60
"Columns" : 40"""
        else:
            mermaid = """graph TD
A[File] --> B[Headers]
B --> C[Content]
C --> D[Visual]"""

        citation = f"""\n\n```mermaid
{mermaid}
By Sheldon K Salmon - Source: https://github.com/AionSystem/AION-BRAIN"""
with open(file_path, 'a', encoding='utf-8') as f:
        f.write(citation)
    print(f"ADDED Mermaid + citation: {file_path}")

except Exception as e:
    print(f"ERROR on {file_path}: {type(e).__name__} - {str(e)}")
processed = 0
for root, _, files in os.walk('.'):
for file in files:
if file.endswith('.md') and not file.startswith('.') and 'visuals/' not in root:
full_path = os.path.join(root, file)
add_mermaid(full_path)
processed += 1
print(f"Finished processing {processed} .md files")
END_SCRIPT
# Run the script
      python3 generate_mermaid.py

  - name: Commit Visual Updates
    uses: stefanzweifel/git-auto-commit-action@v5
    with:
      commit_message: "Auto-generated Mermaid visuals & citations for MD [ci skip]"
      file_pattern: "*.md"