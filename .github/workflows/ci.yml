name: AION Consolidated CI
on: [push, pull_request]

jobs:
  # JOB 1: LINT PYTHON (Runs in parallel)
  lint-python:
    runs-on: ubuntu-latest
    outputs: # This makes the result available to the final job
      status: ${{ steps.lint.outcome }}
      report: ${{ steps.lint.outputs.report }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install & Run Pylint
        id: lint # This ID is important for capturing output
        run: |
          pip install pylint
          # Find .py files, run pylint, capture ALL output to a file
          find engines/ frameworks/ -type f -name "*.py" -exec dirname {} \; | sort -u | while read dir; do
            echo "===== LINTING: $dir =====" >> pylint_report.txt
            pylint "$dir" --recursive=true --exit-zero >> pylint_report.txt 2>&1 || true
            echo "" >> pylint_report.txt
          done
          # Save the report to use later
          echo "report<<EOF" >> $GITHUB_OUTPUT
          cat pylint_report.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # JOB 2: LINT DOCS (Runs in parallel)
  lint-docs:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.lint-docs.outcome }}
      report: ${{ steps.lint-docs.outputs.report }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Lint Markdown
        id: lint-docs
        run: |
          npm install -g markdownlint-cli
          # Run, capture ALL output
          markdownlint "**/*.md" --ignore node_modules 2>&1 | tee md_report.txt
          echo "report<<EOF" >> $GITHUB_OUTPUT
          cat md_report.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # JOB 3: TEST PYTHON (Runs in parallel)
  test-python:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
    outputs:
      status: ${{ steps.test.outcome }}
      report: ${{ steps.test.outputs.report }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install & Run Tests
        id: test
        run: |
          pip install pytest
          # Find and run tests, capture ALL output
          echo "===== PYTEST OUTPUT (Python ${{ matrix.python-version }}) =====" > pytest_report.txt
          find engines/ frameworks/ -type f -name "test_*.py" -exec dirname {} \; | sort -u | while read dir; do
            echo "--- TESTING in: $dir ---" >> pytest_report.txt
            cd "$dir"
            python -m pytest . -v 2>&1 | tee -a ../pytest_report.txt
            cd - > /dev/null
            echo "" >> pytest_report.txt
          done
          # Save the report
          echo "report<<EOF" >> $GITHUB_OUTPUT
          cat pytest_report.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # FINAL JOB: CREATE MASTER ERROR REPORT (Runs after all others)
  create-report:
    runs-on: ubuntu-latest
    needs: [lint-python, lint-docs, test-python] # Waits for all jobs
    steps:
      - name: Generate Consolidated Report
        run: |
          echo "# AION-BRAIN WORKFLOW RESULTS" > workflow-results.txt
          echo "Generated: $(date)" >> workflow-results.txt
          echo "==========================================" >> workflow-results.txt

          echo "## 1. PYTHON LINTING RESULTS" >> workflow-results.txt
          echo "${{ needs.lint-python.outputs.report }}" >> workflow-results.txt

          echo "## 2. DOCUMENTATION LINTING RESULTS" >> workflow-results.txt
          echo "${{ needs.lint-docs.outputs.report }}" >> workflow-results.txt

          echo "## 3. PYTHON TESTING RESULTS" >> workflow-results.txt
          echo "${{ needs.test-python.outputs.report }}" >> workflow-results.txt

          echo "==========================================" >> workflow-results.txt
          echo "END OF REPORT" >> workflow-results.txt

          # Show a preview in the log
          cat workflow-results.txt

      - name: Upload Error Report
        uses: actions/upload-artifact@v4
        with:
          name: workflow-error-report
          path: workflow-results.txt