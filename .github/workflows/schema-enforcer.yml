name: Schema Enforcer
on:
  pull_request:
    paths: ['**/*.yml', '**/*.yaml']
  push:
    branches: [main, master]
    paths: ['**/*.yml', '**/*.yaml']

jobs:
  validate-workflows:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Python packages
        run: |
          echo "üîß Installing required packages..."
          pip install PyYAML jsonschema
          echo "‚úÖ Packages installed"
      
      - name: Validate YAML workflows
        run: |
          echo "üîç Starting workflow validation..."
          
          python3 << 'EOF'
          import os
          import json
          import yaml
          import sys
          from jsonschema import validate, ValidationError
          from pathlib import Path
          
          print("=== AION-BRAIN Workflow Validator ===")
          
          # 1. Check if schema file exists
          schema_path = Path('.github/schemas/workflow-schema.json')
          if not schema_path.exists():
              print(f"‚ùå ERROR: Schema file not found at: {schema_path}")
              print("Create .github/schemas/workflow-schema.json with:")
              print('''
              {
                "$schema": "http://json-schema.org/draft-07/schema#",
                "title": "GitHub Actions Workflow",
                "type": "object",
                "required": ["name", "on", "jobs"],
                "properties": {
                  "name": {"type": "string", "minLength": 1},
                  "on": {"type": ["object", "string", "array"]},
                  "jobs": {"type": "object", "minProperties": 1}
                }
              }
              ''')
              sys.exit(1)
          
          # 2. Load the schema
          try:
              with open(schema_path) as f:
                  workflow_schema = json.load(f)
              print("‚úÖ Schema loaded successfully")
          except json.JSONDecodeError as e:
              print(f"‚ùå ERROR: Invalid JSON in schema file: {e}")
              sys.exit(1)
          
          # 3. Check if workflows directory exists
          workflows_dir = Path('.github/workflows')
          if not workflows_dir.exists():
              print(f"‚ùå ERROR: No .github/workflows directory found")
              sys.exit(1)
          
          # 4. Find all YAML workflow files
          yaml_files = list(workflows_dir.rglob('*.yml'))
          if not yaml_files:
              print("‚ùå ERROR: No .yml files found in .github/workflows/")
              sys.exit(1)
          
          print(f"üìÅ Found {len(yaml_files)} workflow file(s)")
          
          # 5. Validate each file
          errors = []
          validated_count = 0
          
          for yaml_file in sorted(yaml_files):
              file_path = str(yaml_file)
              print(f"\nChecking: {file_path}")
              
              try:
                  # Parse YAML
                  with open(yaml_file) as f:
                      content = yaml.safe_load(f)
                  
                  if content is None:
                      errors.append(f"{file_path}: File is empty")
                      print("  ‚ùå File is empty")
                      continue
                  
                  # Validate against schema
                  validate(instance=content, schema=workflow_schema)
                  validated_count += 1
                  print(f"  ‚úÖ Valid")
                  
              except yaml.YAMLError as e:
                  error_msg = f"{file_path}: YAML syntax error - {str(e).split(':')[-1].strip()}"
                  errors.append(error_msg)
                  print(f"  ‚ùå YAML error: {e}")
              except ValidationError as e:
                  error_msg = f"{file_path}: Missing required field - {e.message.split(':')[-1].strip()}"
                  errors.append(error_msg)
                  print(f"  ‚ùå Schema error: {e.message}")
              except Exception as e:
                  error_msg = f"{file_path}: Unexpected error - {type(e).__name__}: {e}"
                  errors.append(error_msg)
                  print(f"  ‚ùå Unexpected error: {e}")
          
          # 6. Print results
          print(f"\n{'='*50}")
          print("VALIDATION RESULTS:")
          print(f"{'='*50}")
          
          if errors:
              print(f"‚ùå FAILED: {len(errors)} error(s) found")
              print("\nErrors:")
              for i, error in enumerate(errors, 1):
                  print(f"  {i}. {error}")
              sys.exit(1)
          else:
              print(f"‚úÖ SUCCESS: All {validated_count} workflow file(s) are valid")
              print("\nValidated files:")
              for yaml_file in sorted(yaml_files):
                  print(f"  ‚Ä¢ {yaml_file}")
          EOF
      
      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: schema-validation-report
          path: |
            .github/schemas/workflow-schema.json
          retention-days: 7