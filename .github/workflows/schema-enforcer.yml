name: Schema Enforcer
on:
  pull_request:
    paths: ['**/*.yml', '**/*.yaml']
  push:
    branches: [main, master]
    paths: ['**/*.yml', '**/*.yaml']

jobs:
  validate-workflows:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install required packages
        run: |
          pip install PyYAML jsonschema
          echo "âœ… Packages installed"
      
      - name: Check if schema exists
        id: check_schema
        run: |
          if [ -f ".github/schemas/workflow-schema.json" ]; then
            echo "âœ… Schema file exists"
            echo "schema_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Schema file not found"
            echo "Create: .github/schemas/workflow-schema.json"
            echo "schema_exists=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Check if workflows exist
        id: check_workflows
        run: |
          if [ ! -d ".github/workflows" ]; then
            echo "âš ï¸ No workflows directory"
            echo "workflow_count=0" >> $GITHUB_OUTPUT
          else
            COUNT=$(find .github/workflows -name "*.yml" | wc -l)
            echo "Found $COUNT workflow files"
            echo "workflow_count=$COUNT" >> $GITHUB_OUTPUT
          fi
      
      - name: Create validation script
        if: steps.check_schema.outputs.schema_exists == 'true' && steps.check_workflows.outputs.workflow_count != '0'
        run: |
          # Write simple Python script to file
          cat > validate_simple.py << 'EOF'
import os, sys, json, yaml
from jsonschema import validate, ValidationError

print("ðŸ” Starting workflow validation...")

# 1. Load schema
try:
    with open(".github/schemas/workflow-schema.json", "r") as f:
        schema = json.load(f)
    print("âœ… Schema loaded")
except Exception as e:
    print(f"âŒ Failed to load schema: {e}")
    sys.exit(1)

# 2. Find workflow files
workflow_files = []
for root, dirs, files in os.walk(".github/workflows"):
    for file in files:
        if file.endswith(".yml"):
            workflow_files.append(os.path.join(root, file))

if not workflow_files:
    print("âš ï¸ No workflow files found")
    sys.exit(0)

print(f"Found {len(workflow_files)} workflow files")

# 3. Validate each file
errors = []
success_count = 0

for file_path in sorted(workflow_files):
    print(f"\nChecking: {file_path}")
    
    try:
        # Load YAML
        with open(file_path, "r") as f:
            data = yaml.safe_load(f)
        
        if data is None:
            errors.append(f"{file_path}: File is empty")
            print("  âŒ Empty file")
            continue
        
        # Validate
        validate(instance=data, schema=schema)
        success_count += 1
        print("  âœ… Valid")
        
    except yaml.YAMLError as e:
        error_msg = f"{file_path}: YAML error - {str(e)}"
        errors.append(error_msg)
        print(f"  âŒ YAML error: {e}")
    except ValidationError as e:
        error_msg = f"{file_path}: Schema error - {e.message}"
        errors.append(error_msg)
        print(f"  âŒ Schema error: {e.message}")
    except Exception as e:
        error_msg = f"{file_path}: Unexpected error - {type(e).__name__}: {str(e)[:100]}"
        errors.append(error_msg)
        print(f"  âŒ Unexpected: {e}")

# 4. Print results
print(f"\n{'='*50}")
print("VALIDATION RESULTS:")
print(f"{'='*50}")

if errors:
    print(f"âŒ Found {len(errors)} error(s):")
    for error in errors:
        print(f"  â€¢ {error}")
    sys.exit(1)
else:
    print(f"âœ… SUCCESS: All {success_count} workflow file(s) are valid")
    sys.exit(0)
EOF
          echo "âœ… Validation script created"
      
      - name: Run validation
        if: steps.check_schema.outputs.schema_exists == 'true' && steps.check_workflows.outputs.workflow_count != '0'
        run: |
          python3 validate_simple.py
      
      - name: Create summary report
        if: always()
        run: |
          echo ""
          echo "ðŸ“‹ SCHEMA ENFORCER SUMMARY"
          echo "=========================="
          
          if [ "${{ steps.check_schema.outputs.schema_exists }}" = "false" ]; then
            echo "âŒ BLOCKING: Schema file missing"
            echo "   Create: .github/schemas/workflow-schema.json"
          elif [ "${{ steps.check_workflows.outputs.workflow_count }}" = "0" ]; then
            echo "âš ï¸  No workflow files to validate"
          else
            echo "âœ… Validation completed"
          fi