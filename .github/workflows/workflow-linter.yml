name: Workflow Linter & Auto-Fixer

on:
  pull_request:
    paths: ['**/*.yml', '**/*.yaml']
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      auto_commit:
        description: 'Auto-commit fixes (use with caution)'
        required: false
        default: 'false'
        type: choice
        options: ['true', 'false']

jobs:
  lint-and-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install tools
        run: pip install --quiet yamllint pyyaml jsonschema

      - name: Create relaxed yamllint config
        run: |
          cat > .yamllint <<EOF
          extends: default
          rules:
            document-start: disable
            line-length: {max: 160}
            truthy: disable
            indentation: {spaces: consistent, indent-sequences: true}
          EOF

      - name: Lint & auto-fix workflows
        run: |
          EXIT=0
          for file in .github/workflows/*.y*ml; do
            [ -f "$file" ] || continue
            echo "Processing $file"

            cp "$file" "$file.bak"

            yamllint_output=$(yamllint "$file" 2>&1) || true
            if [ -n "$yamllint_output" ]; then
              echo "yamllint issues in $file:"
              echo "$yamllint_output"
              EXIT=1
            fi

            # Auto-format + add name if missing
            python3 - <<'PYEOF' "$file" || { echo "Python fix failed for $file"; EXIT=1; mv "$file.bak" "$file"; }
import sys, yaml, os, traceback
path = sys.argv[1]
try:
    with open(path, 'r', encoding='utf-8') as f:
        data = yaml.safe_load(f) or {}
    modified = False
    if 'name' not in data:
        name = ' '.join(w.capitalize() for w in os.path.basename(path).replace('.yml','').replace('.yaml','').replace('-',' ').split())
        data['name'] = name
        modified = True
        print(f"Added name: {name}")
    with open(path, 'w', encoding='utf-8') as f:
        yaml.dump(data, f, default_flow_style=False, sort_keys=False, width=160, allow_unicode=True, indent=2)
    print("Formatted YAML")
except Exception as e:
    print("Python error:", str(e))
    print(traceback.format_exc())
    sys.exit(1)
PYEOF

          done
          exit $EXIT

      - name: Schema & structure validation
        run: |
          python3 - <<'PYEOF'
import os, yaml, json, sys
from jsonschema import validate, ValidationError

schema = {
    "type": "object",
    "required": ["name", "on", "jobs"],
    "properties": {
        "name": {"type": "string", "minLength": 1},
        "on": {"type": ["object", "string", "array"]},
        "jobs": {"type": "object", "minProperties": 1}
    }
}

errors = []
for root, _, files in os.walk('.github/workflows'):
    for f in files:
        if not f.endswith(('.yml', '.yaml')): continue
        path = os.path.join(root, f)
        try:
            with open(path) as fh:
                data = yaml.safe_load(fh)
            validate(data, schema)
            if 'jobs' in data:
                for j, job in data['jobs'].items():
                    if 'runs-on' not in job:
                        errors.append(f"{f}: Job '{j}' missing 'runs-on'")
        except Exception as e:
            errors.append(f"{f}: {str(e)}")

if errors:
    print("\n".join(errors))
    sys.exit(1)
print("All workflows valid")
PYEOF

      - name: Auto-commit fixes
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.auto_commit == 'true')
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: auto-fix workflow linting & formatting"
          file_pattern: .github/workflows/*.y*ml

      - name: Final status
        run: echo "Linter finished - check logs for details"