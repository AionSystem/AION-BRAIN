name: Schema Enforcer
on:
  pull_request:
    paths: ['**/*.yml', '**/*.yaml']
  push:
    branches: [main, master]
    paths: ['**/*.yml', '**/*.yaml']

jobs:
  validate-workflows:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install validation tools
        run: |
          echo "ğŸ”§ Installing Python packages..."
          pip install jsonschema pyyaml
          echo "âœ… Packages installed"
          python -c "import jsonschema, yaml; print(f'jsonschema version: {jsonschema.__version__}')"
      
      - name: Debug - List workflow files
        run: |
          echo "ğŸ“ Workflow files found:"
          find .github/workflows -name "*.yml" -type f | while read file; do
            echo "  - $file"
          done
          echo "ğŸ“ Schema file check:"
          ls -la .github/schemas/ || echo "No schemas directory"
      
      - name: Validate YAML workflows (with debug)
        run: |
          echo "ğŸ” Starting validation..."
          
          # Create a simpler Python script that's easier to debug
          cat > validate.py << 'EOF'
import os, json, yaml, sys
from pathlib import Path

print("=== DEBUG INFO ===")
print(f"Current directory: {os.getcwd()}")
print(f"Python version: {sys.version}")

# Check if schema file exists
schema_path = Path('.github/schemas/workflow-schema.json')
print(f"Schema path: {schema_path}")
print(f"Schema exists: {schema_path.exists()}")

if schema_path.exists():
    try:
        with open(schema_path) as f:
            schema_content = f.read()
            print(f"Schema size: {len(schema_content)} chars")
            print(f"First 100 chars: {schema_content[:100]}")
            
            # Try to parse JSON
            workflow_schema = json.loads(schema_content)
            print("âœ… Schema JSON parsed successfully")
    except json.JSONDecodeError as e:
        print(f"âŒ Schema JSON error: {e}")
        sys.exit(1)
else:
    print("âŒ Schema file not found")
    sys.exit(1)

print("\n=== VALIDATING WORKFLOWS ===")

errors = []
validated = 0

# Only validate workflow files in .github/workflows/
workflow_dir = Path('.github/workflows')
print(f"Workflow directory: {workflow_dir}")
print(f"Workflow dir exists: {workflow_dir.exists()}")

if workflow_dir.exists():
    for yaml_file in workflow_dir.rglob('*.yml'):
        print(f"\nChecking: {yaml_file}")
        
        try:
            with open(yaml_file) as f:
                content = yaml.safe_load(f)
            print(f"  âœ… YAML parsed, type: {type(content)}")
            
            # Simple validation instead of jsonschema for now
            if not isinstance(content, dict):
                errors.append(f"{yaml_file}: Not a valid YAML dictionary")
            elif 'name' not in content:
                errors.append(f"{yaml_file}: Missing 'name' field")
            elif 'jobs' not in content:
                errors.append(f"{yaml_file}: Missing 'jobs' field")
            else:
                print(f"  âœ… Basic validation passed")
                validated += 1
                
        except yaml.YAMLError as e:
            errors.append(f"{yaml_file}: YAML syntax error - {e}")
            print(f"  âŒ YAML error: {e}")
        except Exception as e:
            errors.append(f"{yaml_file}: Unexpected error - {e}")
            print(f"  âŒ Unexpected error: {e}")
else:
    print("âŒ No .github/workflows directory found")

# Report results
print(f"\n=== RESULTS ===")
print(f"Validated files: {validated}")
print(f"Errors found: {len(errors)}")

if errors:
    print("\nâŒ ERRORS:")
    for error in errors:
        print(f"  - {error}")
    sys.exit(1)
else:
    print("\nâœ… All workflow files passed basic validation")
EOF

          # Run the debug script
          python validate.py