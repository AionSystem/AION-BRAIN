name: Workflow Linter & Auto-Fixer
on:
  pull_request:
    paths: ['**/*.yml', '**/*.yaml']
  push:
    branches: [main, master]

jobs:
  lint-and-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install linter tools
        run: |
          pip install yamllint pyyaml jsonschema
      
      - name: Run yamllint with auto-fix
        run: |
          echo "üîß Linting workflow files..."
          
          # Create a custom yamllint config for GitHub Actions
          cat > .yamllint.yml << 'EOF'
          extends: default
          
          rules:
            document-start: disable  # GitHub Actions doesn't need ---
            line-length:
              max: 120
              allow-non-breakable-words: true
              allow-non-breakable-inline-mappings: true
            truthy:
              check-keys: false  # GitHub Actions uses yes/no as strings
            braces:
              min-spaces-inside: 0
              max-spaces-inside: 0
            brackets:
              min-spaces-inside: 0
              max-spaces-inside: 0
          EOF
          
          # Run yamllint on workflow files
          for file in .github/workflows/*.yml; do
            echo ""
            echo "üìÑ Linting: $file"
            
            # Check for issues
            if yamllint -f parsable "$file" 2>/dev/null | grep -q "error"; then
              echo "  ‚ö†Ô∏è  Found linting issues"
              
              # Create a backup
              cp "$file" "$file.backup"
              
              # Try to auto-fix (yamllint doesn't auto-fix, but we can with Python)
              python3 << 'EOF'
import sys, yaml
file_path = sys.argv[1]

try:
    with open(file_path, 'r') as f:
        content = yaml.safe_load(f)
    
    # Basic auto-fixes
    if content:
        # Ensure 'name' field exists (common missing field)
        if 'name' not in content:
            # Extract name from filename
            import os
            filename = os.path.basename(file_path).replace('.yml', '').replace('-', ' ').title()
            content['name'] = filename
            print(f"  ‚úÖ Added missing 'name' field: {filename}")
        
        # Write back with consistent formatting
        with open(file_path, 'w') as f:
            yaml.dump(content, f, default_flow_style=False, sort_keys=False, width=120)
        
        print(f"  ‚úÖ Auto-formatted: {file_path}")
        
except Exception as e:
    print(f"  ‚ùå Could not auto-fix: {e}")
EOF "$file"
            else
              echo "  ‚úÖ No linting issues found"
            fi
          done
      
      - name: Validate workflow structure
        run: |
          echo "üîç Validating workflow structure..."
          
          python3 << 'EOF'
import os, sys, yaml, json

# Define the minimum required structure
REQUIRED_FIELDS = ['name', 'on', 'jobs']
ERRORS = []

for file in os.listdir('.github/workflows'):
    if file.endswith('.yml'):
        path = os.path.join('.github/workflows', file)
        
        try:
            with open(path, 'r') as f:
                content = yaml.safe_load(f)
            
            if not content:
                ERRORS.append(f"{file}: Empty file")
                continue
            
            # Check required fields
            for field in REQUIRED_FIELDS:
                if field not in content:
                    ERRORS.append(f"{file}: Missing required field '{field}'")
            
            # Check jobs structure
            if 'jobs' in content:
                if not isinstance(content['jobs'], dict) or len(content['jobs']) == 0:
                    ERRORS.append(f"{file}: 'jobs' must be a non-empty dictionary")
                else:
                    for job_name, job_config in content['jobs'].items():
                        if 'runs-on' not in job_config:
                            ERRORS.append(f"{file}: Job '{job_name}' missing 'runs-on'")
            
        except yaml.YAMLError as e:
            ERRORS.append(f"{file}: YAML syntax error - {e}")

# Report results
if ERRORS:
    print("‚ùå VALIDATION ERRORS:")
    for error in ERRORS:
        print(f"  ‚Ä¢ {error}")
    
    print("\nüí° SUGGESTED FIXES:")
    for error in ERRORS:
        if "Missing required field 'name'" in error:
            print(f"  ‚Ä¢ {error}: Add 'name: \"Workflow Name\"' at the top")
        elif "Missing required field 'on'" in error:
            print(f"  ‚Ä¢ {error}: Add triggers like 'on: [push]' or 'on: workflow_dispatch:'")
        elif "Missing required field 'jobs'" in error:
            print(f"  ‚Ä¢ {error}: Add 'jobs:' section with at least one job")
        elif "missing 'runs-on'" in error:
            print(f"  ‚Ä¢ {error}: Add 'runs-on: ubuntu-latest' to the job")
    
    sys.exit(1)
else:
    print("‚úÖ All workflow files have valid structure")
EOF
      
      - name: Create fix suggestions
        if: failure()
        run: |
          echo "üìù Creating fix suggestions..."
          
          cat > fix_suggestions.md << 'EOF'
          # Workflow Fix Suggestions
          
          Based on the validation errors, here are the fixes needed:
          
          ## Common Issues & Fixes:
          
          1. **Missing 'name' field**
             ```yaml
             # Add this at the top of your workflow
             name: "Descriptive Workflow Name"
             ```
          
          2. **Missing 'on' triggers**
             ```yaml
             # Add one of these:
             on: [push]  # Run on all pushes
             on: [pull_request]  # Run on PRs
             on:
               push:
                 branches: [main, master]
             on: workflow_dispatch:  # Manual trigger
             ```
          
          3. **Missing 'jobs' section**
             ```yaml
             jobs:
               example-job:
                 runs-on: ubuntu-latest
                 steps:
                   - run: echo "Hello"
             ```
          
          4. **Missing 'runs-on' in job**
             ```yaml
             jobs:
               my-job:
                 runs-on: ubuntu-latest  # ‚Üê Add this
                 steps: [...]
             ```
          
          ## Quick Fix Script:
          ```bash
          # Auto-add missing name fields
          for file in .github/workflows/*.yml; do
            if ! grep -q "^name:" "$file"; then
              filename=$(basename "$file" .yml)
              read -r -d '' NEW_CONTENT << 'EOM'
          name: ${filename//-/ } Workflow
          
          $(cat "$file")
          EOM
              echo "$NEW_CONTENT" > "$file"
              echo "Fixed: $file"
            fi
          done
          ```
          EOF
          
          echo "‚úÖ Fix suggestions saved to fix_suggestions.md"
      
      - name: Commit auto-fixes
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Check if there are changes
          if git diff --quiet; then
            echo "‚úÖ No fixes needed"
          else
            git add .
            git commit -m "üîß Auto-fix: Workflow linting improvements"
            git push
            echo "‚úÖ Auto-fixes committed and pushed"
          fi
      
      - name: Comment on PR with suggestions
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            let suggestions = '## ‚ö†Ô∏è Workflow Validation Failed\n\n';
            
            // Read the fix suggestions
            try {
              suggestions += fs.readFileSync('fix_suggestions.md', 'utf8');
            } catch (e) {
              suggestions += 'Some workflow files have validation issues. Check the workflow run for details.';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: suggestions
            });