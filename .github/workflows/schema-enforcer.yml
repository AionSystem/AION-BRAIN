name: Schema Enforcer
on:
  pull_request:
    paths: ['**/*.yml', '**/*.yaml']
  push:
    branches: [main, master]
    paths: ['**/*.yml', '**/*.yaml']

jobs:
  validate-workflows:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install required packages
        run: |
          pip install PyYAML jsonschema
          echo "âœ… Packages installed"
      
      - name: Create and run validation
        run: |
          # Create the complete validation script
          cat > validate_work.py << 'EOF_VALIDATE'
import os
import sys
import json
import yaml
from jsonschema import validate, ValidationError

def main():
    print("ðŸ” AION-BRAIN Workflow Validator")
    print("=" * 50)
    
    # 1. Check if schema exists
    schema_path = ".github/schemas/workflow-schema.json"
    if not os.path.exists(schema_path):
        print(f"âŒ ERROR: Schema file not found at: {schema_path}")
        print("\nCreate this file with:")
        print('''
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "GitHub Actions Workflow",
  "type": "object",
  "required": ["name", "on", "jobs"],
  "properties": {
    "name": {"type": "string", "minLength": 1},
    "on": {"type": ["object", "string", "array"]},
    "jobs": {"type": "object", "minProperties": 1}
  }
}
        ''')
        return 1
    
    # 2. Load schema
    try:
        with open(schema_path, "r") as f:
            schema = json.load(f)
        print("âœ… Schema loaded successfully")
    except json.JSONDecodeError as e:
        print(f"âŒ ERROR: Invalid JSON in schema: {e}")
        return 1
    
    # 3. Check for workflows directory
    if not os.path.exists(".github/workflows"):
        print("âš ï¸  No .github/workflows directory found")
        return 0
    
    # 4. Find all workflow files
    workflow_files = []
    for root, dirs, files in os.walk(".github/workflows"):
        for file in files:
            if file.endswith(".yml"):
                full_path = os.path.join(root, file)
                workflow_files.append(full_path)
    
    if not workflow_files:
        print("âš ï¸  No .yml files found in .github/workflows/")
        return 0
    
    print(f"ðŸ“ Found {len(workflow_files)} workflow file(s)")
    print("-" * 50)
    
    # 5. Validate each file
    errors = []
    success_count = 0
    
    for file_path in sorted(workflow_files):
        print(f"\nChecking: {file_path}")
        
        try:
            # Load YAML content
            with open(file_path, "r") as f:
                content = yaml.safe_load(f)
            
            if content is None:
                errors.append(f"{file_path}: File is empty or contains only comments")
                print("  âŒ Empty file")
                continue
            
            # Validate against schema
            validate(instance=content, schema=schema)
            success_count += 1
            print("  âœ… Valid")
            
        except yaml.YAMLError as e:
            error_msg = f"{file_path}: YAML syntax error"
            if hasattr(e, 'problem'):
                error_msg += f" - {e.problem}"
            errors.append(error_msg)
            print(f"  âŒ YAML error: {e}")
        except ValidationError as e:
            # Extract the meaningful part of the error
            error_parts = str(e).split('\n')
            error_msg = f"{file_path}: {error_parts[0]}"
            errors.append(error_msg)
            print(f"  âŒ Schema error: {error_parts[0]}")
        except Exception as e:
            errors.append(f"{file_path}: Unexpected error - {type(e).__name__}")
            print(f"  âŒ Unexpected: {type(e).__name__}")
    
    # 6. Print final results
    print(f"\n{'='*50}")
    print("VALIDATION RESULTS:")
    print(f"{'='*50}")
    
    if errors:
        print(f"âŒ FAILED: {len(errors)} error(s) found")
        print("\nDetailed errors:")
        for i, error in enumerate(errors, 1):
            print(f"  {i}. {error}")
        print(f"\nâœ… Valid files: {success_count}")
        return 1
    else:
        print(f"âœ… SUCCESS: All {success_count} workflow file(s) are valid")
        return 0

if __name__ == "__main__":
    sys.exit(main())
EOF_VALIDATE
          
          # Run the validation
          python3 validate_work.py