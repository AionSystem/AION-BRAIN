name: Framework Integrity and README Sync (MD Only)

on:
  push:
    paths: ['frameworks/**', 'README.md']
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC
  workflow_dispatch:

jobs:
  sync-md:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install markdownlint
        run: |
          npm install -g markdownlint-cli
          markdownlint --version  # Quick check

      - name: Lint and auto-fix MD files in frameworks/
        run: |
          echo "Linting and fixing Markdown files..."
          find frameworks -type f -name "*.md" ! -name ".*" -exec markdownlint --fix {} \; || echo "Lint had non-fatal issues"
          echo "Linting complete."

      - name: Update README with frameworks summary
        run: |
          python3 - <<EOF
          import os
          import re

          summary_lines = ["## Frameworks Overview (Auto-generated)\n"]
          for root, dirs, files in os.walk('frameworks'):
              level = root.replace('frameworks', '').count(os.sep)
              indent = '  ' * level
              if level > 0:
                  folder_name = os.path.basename(root)
                  summary_lines.append(f"{indent}- **{folder_name}/**\n")
              for file in sorted(files):
                  if file.endswith('.md'):
                      path = os.path.join(root, file)
                      rel_path = os.path.relpath(path, '.')
                      try:
                          with open(path, 'r', encoding='utf-8') as f:
                              content = f.read()
                          version_match = re.search(r'(?i)version:\s*([\d\.]+)', content)
                          version = version_match.group(1) if version_match else 'Unknown'
                          summary_lines.append(f"{indent}  - [{file}]({rel_path}) â€” Version {version}\n")
                      except Exception as e:
                          print(f"Warning reading {path}: {e}")

          summary = ''.join(summary_lines)

          readme_path = 'README.md'
          if os.path.exists(readme_path):
              with open(readme_path, 'r', encoding='utf-8') as f:
                  content = f.read()
              if '## Frameworks Overview (Auto-generated)' in content:
                  parts = content.split('## Frameworks Overview (Auto-generated)', 1)
                  new_content = parts[0] + summary + (parts[1].split('\n', 1)[1] if len(parts) > 1 else '')
              else:
                  new_content = content.rstrip() + '\n\n' + summary
              with open(readme_path, 'w', encoding='utf-8') as f:
                  f.write(new_content)
              print("README.md updated.")
          EOF

      - name: Commit Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-lint MD files & synced README [ci skip]"
          file_pattern: "frameworks/**/*.md README.md"