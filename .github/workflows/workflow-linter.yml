name: Workflow Linter & Auto-Fixer
on:
  pull_request:
    paths: ['**/*.yml', '**/*.yaml']
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      auto_commit:
        description: 'Auto-commit fixes (use with caution)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  lint-and-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install linter tools
        run: |
          pip install --quiet yamllint pyyaml jsonschema
          echo "‚úÖ Installed: yamllint, PyYAML, jsonschema"

      - name: Debug - List files and check schema
        run: |
          echo "üîç DEBUG INFO:"
          echo "Current directory: $(pwd)"
          echo ""
          echo "Schema directories:"
          ls -la .github/schema/ .github/schemas/ 2>/dev/null || echo "No schema directories found"
          echo ""
          echo "Workflow files:"
          ls -la .github/workflows/*.yml 2>/dev/null || echo "No workflow files found"
          echo ""
          echo "Checking if schema exists:"
          if [ -f ".github/schemas/workflow-schema.json" ]; then
            echo "‚úÖ Schema exists at .github/schemas/workflow-schema.json"
            python3 -c "import json; json.load(open('.github/schemas/workflow-schema.json')); print('Schema is valid JSON')"
          elif [ -f ".github/schema/workflow-schema.json" ]; then
            echo "‚úÖ Schema exists at .github/schema/workflow-schema.json"
            python3 -c "import json; json.load(open('.github/schema/workflow-schema.json')); print('Schema is valid JSON')"
          else
            echo "‚ö†Ô∏è  No schema file found"
          fi

      - name: Create yamllint config
        run: |
          cat > .yamllint.yml <<'EOF'
extends: default
rules:
  document-start: disable
  line-length:
    max: 120
    allow-non-breakable-words: true
    allow-non-breakable-inline-mappings: true
  truthy:
    check-keys: false
  braces:
    min-spaces-inside: 0
    max-spaces-inside: 0
  brackets:
    min-spaces-inside: 0
    max-spaces-inside: 0
  comments:
    min-spaces-from-content: 1
EOF
          echo "‚úÖ yamllint config created"

      - name: Lint this workflow file first
        run: |
          echo "üîç Self-check: Validating this linter workflow..."
          if yamllint .github/workflows/workflow-linter.yml; then
            echo "‚úÖ This workflow file passes yamllint"
          else
            echo "‚ùå This workflow file has linting issues!"
            exit 1
          fi

      - name: Run yamllint with auto-fix
        id: yamllint
        continue-on-error: true
        run: |
          echo "üîß Linting workflow files..."
          shopt -s nullglob
          EXIT_CODE=0
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            [ -f "$file" ] || continue
            echo ""
            echo "üìÑ Linting: $file"
            if ! yamllint_output=$(yamllint -f parsable "$file" 2>&1); then
              echo "  ‚ö†Ô∏è  Found linting issues:"
              echo "$yamllint_output" | sed 's/^/    /'
              EXIT_CODE=1
              cp "$file" "$file.backup"
              echo "  üíæ Backup created: $file.backup"

              python3 "$file" <<'PYEOF'
import os
import sys
import yaml

file_path = sys.argv[1]
try:
    with open(file_path, 'r') as f:
        content = yaml.safe_load(f)
    if content:
        if 'name' not in content:
            basename = os.path.basename(file_path)
            filename = (basename.replace('.yml', '')
                               .replace('.yaml', '')
                               .replace('-', ' ')
                               .replace('_', ' ')
                               .title())
            content['name'] = filename
            print(f"  ‚úÖ Added missing 'name' field: {filename}")
        with open(file_path, 'w') as f:
            yaml.dump(content, f, default_flow_style=False,
                      sort_keys=False, width=120, allow_unicode=True)
        print(f"  ‚úÖ Auto-formatted: {file_path}")
except Exception as e:
    print(f"  ‚ùå Could not auto-fix: {e}", file=sys.stderr)
    sys.exit(1)
PYEOF

              if [ $? -ne 0 ]; then
                echo "  ‚ö†Ô∏è  Auto-fix failed, restoring backup"
                mv "$file.backup" "$file"
              fi
            else
              echo "  ‚úÖ No linting issues found"
            fi
          done
          exit $EXIT_CODE

      - name: Validate against JSON schema
        id: schema_validation
        continue-on-error: true
        run: |
          echo "üîç Validating workflows against schema..."
          SCHEMA_FOUND=false
          if [ -f ".github/schemas/workflow-schema.json" ]; then
            SCHEMA_PATH=".github/schemas/workflow-schema.json"
            SCHEMA_FOUND=true
          elif [ -f ".github/schema/workflow-schema.json" ]; then
            SCHEMA_PATH=".github/schema/workflow-schema.json"
            SCHEMA_FOUND=true
          fi
          if [ "$SCHEMA_FOUND" = false ]; then
            echo "‚ö†Ô∏è  No schema file found at .github/schema/ or .github/schemas/"
            mkdir -p .github/schemas
            cat > .github/schemas/workflow-schema.json <<'EOF'
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "GitHub Actions Workflow",
  "type": "object",
  "required": ["name", "on", "jobs"],
  "properties": {
    "name": {"type": "string", "minLength": 1},
    "on": {"type": ["object", "string", "array"]},
    "jobs": {"type": "object", "minProperties": 1}
  }
}
EOF
            SCHEMA_PATH=".github/schemas/workflow-schema.json"
          fi

          python3 "$SCHEMA_PATH" <<'PYEOF'
import os
import sys
import yaml
import json
from jsonschema import validate, ValidationError

SCHEMA_PATH = sys.argv[1]
ERRORS = []
VALIDATED = 0

with open(SCHEMA_PATH, 'r') as f:
    schema = json.load(f)

workflow_dir = '.github/workflows'
if not os.path.exists(workflow_dir):
    sys.exit(0)

for file in os.listdir(workflow_dir):
    if file.endswith(('.yml', '.yaml')):
        path = os.path.join(workflow_dir, file)
        with open(path, 'r') as f:
            content = yaml.safe_load(f)
        try:
            validate(instance=content, schema=schema)
            VALIDATED += 1
        except ValidationError as e:
            ERRORS.append(f"{file}: {e.message}")

if ERRORS:
    for error in ERRORS:
        print(error)
    sys.exit(1)
else:
    print(f"‚úÖ {VALIDATED} workflows validated successfully")
PYEOF

      - name: Set final status
        if: always()
        run: |
          echo "üìä Workflow Linter Summary"
          echo "=========================="
          echo "yamllint: ${{ steps.yamllint.outcome }}"
          echo "Schema validation: ${{ steps.schema_validation.outcome }}"
          echo ""
          if [ "${{ steps.yamllint.outcome }}" = "success" ] && \
             [ "${{ steps.schema_validation.outcome }}" = "success" ]; then
            echo "‚úÖ All validations passed!"
            exit 0
          else
            echo "‚ùå Some validations failed - review the logs above"
            exit 1
          fi