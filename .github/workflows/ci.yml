name: Continuous Integration (CI)
on: [push, pull_request]

jobs:
  # JOB 1: Lint Python Code (Only in folders with Python files)
  lint-python:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Pylint
        run: pip install pylint

      - name: Discover and Lint Python Projects
        run: |
          # This script finds directories containing .py files and runs pylint on them.
          echo "ðŸ” Searching for Python projects in engines/ and frameworks/ ..."
          find engines/ frameworks/ -type f -name "*.py" | while read py_file; do
            project_dir=$(dirname "$py_file")
            # Use a marker to avoid linting the same directory multiple times
            if [ ! -f "$project_dir/.linted" ]; then
              echo "--- Linting Python project in: $project_dir ---"
              pylint "$project_dir" --recursive=true --exit-zero || true
              touch "$project_dir/.linted"
            fi
          done
          echo "âœ… Python linting discovery complete."

  # JOB 2: Lint Documentation (Your existing, working workflow)
  lint-docs:
    uses: ./.github/workflows/lint-docs.yml

  # JOB 3: Run Python Tests (Only in projects that have tests)
  test-python:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install pytest
          # Install any global project dependencies if you have a root requirements.txt
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Discover and Run Tests
        run: |
          # This script finds test files and runs pytest in their parent directories.
          echo "ðŸ” Searching for test files (test_*.py) in engines/ and frameworks/ ..."
          find engines/ frameworks/ -type f -name "test_*.py" | while read test_file; do
            test_dir=$(dirname "$test_file")
            echo "--- Running tests in: $test_dir ---"
            cd "$test_dir"
            python -m pytest . --verbose -q || echo "âš ï¸  Tests failed or no tests collected in $test_dir"
            cd - > /dev/null
          done
          echo "âœ… Test discovery complete."