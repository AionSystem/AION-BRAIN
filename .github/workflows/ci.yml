name: AION Consolidated CI
on: [push, pull_request]

defaults:
  run:
    shell: bash

jobs:
  # JOB 1: LINT PYTHON (SMART DISCOVERY)
  lint-python:
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      status: ${{ job.status }}
      report_file: pylint_output.txt
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Discover and Lint Python
        id: lint-run
        run: |
          echo "ðŸ” Starting Python lint discovery..." > pylint_output.txt
          echo "======================================" >> pylint_output.txt
          
          # Use 'find' safely: if no .py files, just report it.
          PY_FILES=$(find engines/ frameworks/ -type f -name "*.py" 2>/dev/null || echo "")
          
          if [ -z "$PY_FILES" ]; then
            echo "ðŸ“­ No Python (.py) source files found to lint in 'engines/' or 'frameworks/'." >> pylint_output.txt
            echo "   This is OK for engines that are documentation-only." >> pylint_output.txt
            exit 0
          fi
          
          pip install pylint -q
          
          # Get unique directories containing .py files
          echo "$PY_FILES" | xargs -I {} dirname {} | sort -u | while read DIR; do
            echo "--- Linting: $DIR ---" >> pylint_output.txt
            pylint "$DIR" --recursive=true --exit-zero 2>&1 | head -50 >> pylint_output.txt || true
            echo "" >> pylint_output.txt
          done
          
          echo "âœ… Python lint discovery complete." >> pylint_output.txt
      - name: Upload Python Lint Report
        uses: actions/upload-artifact@v4
        with:
          name: python-lint-artifact
          path: pylint_output.txt

  # JOB 2: LINT DOCS (FIXED WITH OUTPUTS)
  lint-docs:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ job.status }}
      report_file: markdownlint_output.txt
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Markdown Linter
        run: npm install -g markdownlint-cli@0.36.0

      - name: Run markdownlint
        id: lint-run
        run: |
          echo "ðŸ” Starting Markdown linting..." > markdownlint_output.txt
          echo "======================================" >> markdownlint_output.txt
          
          # Run markdownlint on all .md files
          find . -name "*.md" -not -path "./.*" | while read -r file; do
            echo "--- Checking: $file ---" >> markdownlint_output.txt
            markdownlint "$file" 2>&1 | head -30 >> markdownlint_output.txt || true
            echo "" >> markdownlint_output.txt
          done
          
          echo "âœ… Markdown linting complete." >> markdownlint_output.txt
          
      - name: Upload Markdown Lint Report
        uses: actions/upload-artifact@v4
        with:
          name: markdown-lint-artifact
          path: markdownlint_output.txt

  # JOB 3: TEST PYTHON (SMART DISCOVERY)
  test-python:
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      status: ${{ job.status }}
      report_file: pytest_output.txt
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Discover and Run Tests
        id: test-run
        run: |
          echo "ðŸ” Starting Python test discovery..." > pytest_output.txt
          echo "======================================" >> pytest_output.txt
          
          # Find test files safely
          TEST_FILES=$(find engines/ frameworks/ -type f -name "test_*.py" 2>/dev/null || echo "")
          
          if [ -z "$TEST_FILES" ]; then
            echo "ðŸ“­ No test files (test_*.py) found in 'engines/' or 'frameworks/'." >> pytest_output.txt
            echo "   This is expected for now. Add 'test_*.py' files to enable testing." >> pytest_output.txt
            exit 0
          fi
          
          pip install pytest -q
          
          # Run tests from each unique test directory
          echo "$TEST_FILES" | xargs -I {} dirname {} | sort -u | while read TEST_DIR; do
            echo "--- Testing in: $TEST_DIR ---" >> pytest_output.txt
            cd "$TEST_DIR"
            python -m pytest . -v 2>&1 | head -100 >> ../pytest_output.txt || echo "   âš ï¸  Some tests failed." >> ../pytest_output.txt
            cd - > /dev/null
            echo "" >> pytest_output.txt
          done
          
          echo "âœ… Python test discovery complete." >> pytest_output.txt
      - name: Upload Python Test Report
        uses: actions/upload-artifact@v4
        with:
          name: python-test-artifact
          path: pytest_output.txt

  # FINAL JOB: CREATE THE MASTER REPORT (FIXED)
  create-master-report:
    runs-on: ubuntu-latest
    needs: [lint-python, lint-docs, test-python]
    if: always()
    steps:
      - name: Download All Job Reports
        uses: actions/download-artifact@v4
        with:
          path: ./downloaded-artifacts
          
      - name: Generate Master Report
        run: |
          echo "# ðŸ§  AION-BRAIN: CONSOLIDATED CI REPORT" > MASTER_REPORT.md
          echo "**Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> MASTER_REPORT.md
          echo "**Workflow Run:** [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> MASTER_REPORT.md
          echo "---" >> MASTER_REPORT.md
          echo "" >> MASTER_REPORT.md
          
          echo "## ðŸ“‹ EXECUTIVE SUMMARY" >> MASTER_REPORT.md
          echo "" >> MASTER_REPORT.md
          echo "| Job | Status | Details |" >> MASTER_REPORT.md
          echo "|-----|--------|---------|" >> MASTER_REPORT.md
          echo "| Python Linting | **${{ needs.lint-python.result }}** | [View Report](#1-python-linting-details) |" >> MASTER_REPORT.md
          echo "| Documentation Linting | **${{ needs.lint-docs.result }}** | [View Report](#2-markdown-linting-details) |" >> MASTER_REPORT.md
          echo "| Python Testing | **${{ needs.test-python.result }}** | [View Report](#3-python-testing-details) |" >> MASTER_REPORT.md
          echo "" >> MASTER_REPORT.md
          
          # Python Linting
          echo "## 1. PYTHON LINTING DETAILS" >> MASTER_REPORT.md
          echo '```' >> MASTER_REPORT.md
          if [ -f "./downloaded-artifacts/python-lint-artifact/pylint_output.txt" ]; then
            cat ./downloaded-artifacts/python-lint-artifact/pylint_output.txt >> MASTER_REPORT.md
          else
            echo "No Python linting report available." >> MASTER_REPORT.md
          fi
          echo '```' >> MASTER_REPORT.md
          echo "" >> MASTER_REPORT.md
          
          # Markdown Linting
          echo "## 2. MARKDOWN LINTING DETAILS" >> MASTER_REPORT.md
          echo '```' >> MASTER_REPORT.md
          if [ -f "./downloaded-artifacts/markdown-lint-artifact/markdownlint_output.txt" ]; then
            cat ./downloaded-artifacts/markdown-lint-artifact/markdownlint_output.txt >> MASTER_REPORT.md
          else
            echo "No markdown linting report available." >> MASTER_REPORT.md
          fi
          echo '```' >> MASTER_REPORT.md
          echo "" >> MASTER_REPORT.md
          
          # Python Testing
          echo "## 3. PYTHON TESTING DETAILS" >> MASTER_REPORT.md
          echo '```' >> MASTER_REPORT.md
          if [ -f "./downloaded-artifacts/python-test-artifact/pytest_output.txt" ]; then
            cat ./downloaded-artifacts/python-test-artifact/pytest_output.txt >> MASTER_REPORT.md
          else
            echo "No Python testing report available." >> MASTER_REPORT.md
          fi
          echo '```' >> MASTER_REPORT.md
          echo "" >> MASTER_REPORT.md
          
          echo "---" >> MASTER_REPORT.md
          echo "*This report was generated automatically by the AION Consolidated CI workflow.*" >> MASTER_REPORT.md
          
          echo "ðŸ“„ Master report generated: MASTER_REPORT.md"
          
      - name: Upload Master Report
        uses: actions/upload-artifact@v4
        with:
          name: aion-ci-master-report
          path: MASTER_REPORT.md