name: Visual Structure Extraction and Citation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  extract-and-visualize:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'  # or '3.12' — pdfplumber supports >=3.8

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pdfplumber markdown-it-py

      - name: Install Node.js dependencies (for mermaid.cli if needed later)
        run: npm install -g @mermaid-js/mermaid-cli

      - name: Scan and Generate Mermaid
        run: |
          python - <<EOF
          import os
          import pdfplumber
          from markdown_it import MarkdownIt

          def add_mermaid(file_path):
              if file_path.endswith('.md'):
                  with open(file_path, 'r', encoding='utf-8') as f:
                      content = f.read()
                  md = MarkdownIt()
                  # Basic table detection (improve as needed)
                  has_table = '|' in content and content.count('|') > 5
                  if has_table:
                      # Simple placeholder conversion — customize per your tables
                      mermaid = 'graph TD\n    A[Table Detected] --> B[Data]\n    B --> C[Visualized]'
                  else:
                      # Basic file structure diagram
                      mermaid = 'graph TD\n    Root[File] --> Headers[Headers]\n    Headers --> Subsections[Content]'

                  citation = f"""\n\n```mermaid\n{mermaid}\n```\n\n*By Sheldon K Salmon - Source: https://github.com/AionSystem/AION-BRAIN*"""
                  with open(file_path, 'a', encoding='utf-8') as f:
                      f.write(citation)
                  print(f"Processed MD: {file_path}")

              elif file_path.lower().endswith('.pdf'):
                  try:
                      with pdfplumber.open(file_path) as pdf:
                          for i, page in enumerate(pdf.pages):
                              tables = page.extract_tables()
                              if tables:
                                  # Basic conversion — improve for real table-to-chart
                                  mermaid = 'graph LR\n    Col1[Column1] --> Val1[Value]'
                                  out_path = f"visuals/{os.path.basename(file_path)}_page{i+1}.md"
                                  os.makedirs('visuals', exist_ok=True)
                                  with open(out_path, 'w', encoding='utf-8') as f:
                                      f.write(f"```mermaid\n{mermaid}\n```\n\n*By Sheldon K Salmon - Source: https://github.com/AionSystem/AION-BRAIN*")
                                  print(f"Generated from PDF table: {out_path}")
                              else:
                                  print(f"No tables in PDF page {i+1} of {file_path}")
                  except Exception as e:
                      print(f"PDF processing error {file_path}: {e}")

          for root, _, files in os.walk('.'):
              for file in files:
                  if file.endswith(('.md', '.pdf')) and not file.startswith('.'):
                      add_mermaid(os.path.join(root, file))
          EOF

      - name: Commit Visual Updates
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-generated Mermaid visuals with citations [ci skip]"
          file_pattern: "*.md visuals/*.md"