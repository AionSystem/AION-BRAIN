name: Schema Enforcer
on:
  pull_request:
    paths: ['**/*.yml', '**/*.yaml']
  push:
    branches: [main, master]
    paths: ['**/*.yml', '**/*.yaml']

jobs:
  validate-workflows:
    runs-on: ubuntu-latest
    # Continue even if validation fails - report but don't block
    continue-on-error: true
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python with dependency verification
        id: setup
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install and verify dependencies
        id: deps
        run: |
          set -e  # Exit on any error immediately
          echo "üîß Installing validation dependencies..."
          
          # Install with explicit versions for reproducibility
          pip install "PyYAML>=6.0" "jsonschema>=4.20.0"
          
          # Verify installations
          python3 -c "
          import pkg_resources
          required = {'PyYAML': '6.0', 'jsonschema': '4.20.0'}
          for pkg, min_version in required.items():
              try:
                  version = pkg_resources.get_distribution(pkg).version
                  print(f'‚úÖ {pkg}: {version}')
                  if pkg_resources.parse_version(version) < pkg_resources.parse_version(min_version):
                      print(f'‚ùå {pkg} version {version} < required {min_version}')
                      exit(1)
              except pkg_resources.DistributionNotFound:
                  print(f'‚ùå {pkg} not installed')
                  exit(1)
          "
          echo "deps_status=success" >> $GITHUB_OUTPUT
      
      - name: Check for schema file
        id: check_schema
        continue-on-error: true
        run: |
          SCHEMA_FILE=".github/schemas/workflow-schema.json"
          if [ ! -f "$SCHEMA_FILE" ]; then
            echo "::error::Schema file not found: $SCHEMA_FILE"
            echo "schema_status=missing" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Quick JSON syntax check
          if ! python3 -m json.tool "$SCHEMA_FILE" > /dev/null 2>&1; then
            echo "::error::Invalid JSON in schema file"
            echo "schema_status=invalid" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "schema_status=valid" >> $GITHUB_OUTPUT
          echo "‚úÖ Schema file exists and is valid JSON"
      
      - name: Check for workflow files
        id: check_workflows
        run: |
          if [ ! -d ".github/workflows" ]; then
            echo "::warning::No .github/workflows directory found"
            echo "workflow_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          COUNT=$(find .github/workflows -name "*.yml" -type f | wc -l)
          echo "workflow_count=$COUNT" >> $GITHUB_OUTPUT
          echo "üìÅ Found $COUNT workflow file(s)"
      
      - name: Validate workflows (file by file)
        id: validate
        if: steps.check_workflows.outputs.workflow_count != '0' && steps.check_schema.outputs.schema_status == 'valid'
        run: |
          echo "üîç Starting validation (fail-fast disabled)..."
          
          # Create error report file
          ERROR_REPORT=".github/validation-errors-$(date +%s).txt"
          echo "AION-BRAIN Workflow Validation Report" > "$ERROR_REPORT"
          echo "Generated: $(date)" >> "$ERROR_REPORT"
          echo "======================================" >> "$ERROR_REPORT"
          
          # Process files ONE AT A TIME to avoid memory issues
          find .github/workflows -name "*.yml" -type f | sort | while read -r YAML_FILE; do
            echo ""
            echo "Processing: $YAML_FILE"
            
            # Run validation in isolated subprocess
            python3 << 'EOF' 2>&1 | tee -a "$ERROR_REPORT"
import sys
import json
import traceback

def validate_single_file(yaml_file_path):
    """Validate a single YAML file - isolated from others"""
    try:
        # Import INSIDE function to catch import errors per-file
        import yaml
        from jsonschema import validate, ValidationError
        from pathlib import Path
        
        # Load schema
        schema_path = Path('.github/schemas/workflow-schema.json')
        with open(schema_path) as f:
            workflow_schema = json.load(f)
        
        # Load and validate YAML
        with open(yaml_file_path) as f:
            content = yaml.safe_load(f)
        
        if content is None:
            return f"‚ùå {yaml_file_path}: File is empty or contains only comments"
        
        validate(instance=content, schema=workflow_schema)
        return f"‚úÖ {yaml_file_path}: Valid"
        
    except ImportError as e:
        return f"‚ö†Ô∏è {yaml_file_path}: Missing dependency - {e}"
    except yaml.YAMLError as e:
        return f"‚ùå {yaml_file_path}: YAML syntax error - {str(e).split(':')[-1].strip()}"
    except json.JSONDecodeError as e:
        return f"‚ùå {yaml_file_path}: Schema JSON error - {e}"
    except ValidationError as e:
        # Extract just the meaningful part of the error
        error_msg = str(e).split('\n')[0]
        return f"‚ùå {yaml_file_path}: Schema violation - {error_msg}"
    except Exception as e:
        return f"‚ö†Ô∏è {yaml_file_path}: Unexpected error - {type(e).__name__}: {str(e)[:100]}"
    
if __name__ == "__main__":
    if len(sys.argv) > 1:
        result = validate_single_file(sys.argv[1])
        print(result)
        # Exit 0 regardless - we collect errors, not fail fast
        sys.exit(0)
    else:
        print("Error: No file specified")
        sys.exit(1)
EOF "$YAML_FILE"
            
            # Check the Python exit code but continue anyway
            PYTHON_EXIT=$?
            if [ $PYTHON_EXIT -ne 0 ]; then
              echo "::warning::Python validation script had issues with $YAML_FILE (exit $PYTHON_EXIT)"
            fi
            
          done  # End of file loop
          
          echo "" >> "$ERROR_REPORT"
          echo "=== END REPORT ===" >> "$ERROR_REPORT"
          
          # Count errors from report
          ERROR_COUNT=$(grep -c "‚ùå" "$ERROR_REPORT" || true)
          WARNING_COUNT=$(grep -c "‚ö†Ô∏è" "$ERROR_REPORT" || true)
          SUCCESS_COUNT=$(grep -c "‚úÖ" "$ERROR_REPORT" || true)
          
          echo ""
          echo "üìä VALIDATION SUMMARY:"
          echo "  ‚úÖ Valid files: $SUCCESS_COUNT"
          echo "  ‚ö†Ô∏è  Warnings: $WARNING_COUNT"
          echo "  ‚ùå Errors: $ERROR_COUNT"
          
          # Save counts to outputs
          echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT
          echo "warning_count=$WARNING_COUNT" >> $GITHUB_OUTPUT
          echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
      
      - name: Upload error report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-error-report
          path: .github/validation-errors-*.txt
          retention-days: 1
      
      - name: Final status report
        if: always()
        run: |
          echo "=== FINAL VALIDATION STATUS ==="
          
          if [ "${{ steps.check_schema.outputs.schema_status }}" = "missing" ]; then
            echo "‚ùå BLOCKING: Schema file missing"
            echo "Create .github/schemas/workflow-schema.json"
            exit 1
          fi
          
          if [ "${{ steps.check_schema.outputs.schema_status }}" = "invalid" ]; then
            echo "‚ùå BLOCKING: Schema file has invalid JSON"
            exit 1
          fi
          
          if [ "${{ steps.deps.outputs.deps_status }}" != "success" ]; then
            echo "‚ùå BLOCKING: Dependency installation failed"
            exit 1
          fi
          
          ERROR_COUNT="${{ steps.validate.outputs.error_count || 0 }}"
          
          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "‚ùå VALIDATION FAILED: $ERROR_COUNT error(s) found"
            echo "Download the validation-error-report artifact for details"
            exit 1
          elif [ "${{ steps.check_workflows.outputs.workflow_count }}" = "0" ]; then
            echo "‚ö†Ô∏è  SKIPPED: No workflow files found"
            exit 0
          else
            echo "‚úÖ VALIDATION PASSED"
            echo "All ${{ steps.validate.outputs.success_count }} workflow file(s) are valid"
            exit 0
          fi