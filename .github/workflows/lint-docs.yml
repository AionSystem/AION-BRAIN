name: Lint Markdown Documentation

on:
  workflow_call:
    inputs:
      token:
        required: true
        type: string
    outputs:
      status:
        value: ${{ jobs.markdown-lint.result }}
      report:
        value: ${{ jobs.markdown-lint.outputs.report_file }}

jobs:
  markdown-lint:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ job.status }}
      report_file: markdownlint_output.txt
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install latest Markdown Linter
        run: npm install -g markdownlint-cli  # Remove @0.36.0 pin â†’ use latest (v0.41+ as of 2026)

      - name: Run markdownlint with relaxed config for specs
        id: lint-run
        run: |
          echo "ðŸ” Starting Markdown linting for technical specs..." > markdownlint_output.txt
          echo "======================================" >> markdownlint_output.txt
          
          # If .markdownlint.json exists, use it; otherwise fall back to inline relaxed config
          CONFIG_ARG=""
          if [ -f .markdownlint.json ]; then
            CONFIG_ARG="--config .markdownlint.json"
            echo "Using project .markdownlint.json" >> markdownlint_output.txt
          else
            echo "No .markdownlint.json found â†’ using relaxed inline config for specs/whitepapers" >> markdownlint_output.txt
            CONFIG_ARG="--config"
            cat <<EOF > temp-relaxed.json
          {
            "default": true,
            "MD013": { "line_length": 120, "code_blocks": false, "tables": false },
            "MD041": false,
            "MD046": { "style": "fenced" },
            "MD022": false,
            "MD007": { "indent": 2 },
            "MD047": true,
            "MD009": true,
            "MD033": false,
            "MD024": false
          }
          EOF
            CONFIG_ARG="--config temp-relaxed.json"
          fi
          
          # Run on all .md files
          find . -type f -name "*.md" -not -path "./.*" -not -path "./node_modules/*" | sort | while read -r file; do
            echo "--- Checking: $file ---" >> markdownlint_output.txt
            markdownlint "$file" $CONFIG_ARG 2>&1 >> markdownlint_output.txt || true
            echo "" >> markdownlint_output.txt
          done
          
          # Summary: count real errors (ignore if only warnings or no MDxxx)
          ERROR_COUNT=$(grep -c "MD[0-9]\{3\}" markdownlint_output.txt || echo 0)
          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "âš ï¸ Markdown linting complete â€” $ERROR_COUNT potential issues found." >> markdownlint_output.txt
          else
            echo "âœ… Markdown linting complete â€” no issues detected." >> markdownlint_output.txt
          fi

      - name: Upload Markdown Lint Report
        uses: actions/upload-artifact@v4
        with:
          name: markdown-lint-artifact
          path: markdownlint_output.txt
          if-no-files-found: warn  # Don't fail if no report (edge case)