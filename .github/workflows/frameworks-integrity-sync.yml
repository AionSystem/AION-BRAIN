name: Framework Integrity and README Sync

on:
  push:
    paths: ['frameworks/**', 'README.md']
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC
  workflow_dispatch:

jobs:
  validate-and-sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install tools (Pandoc 3.9 latest + markdownlint)
        run: |
          # Install Pandoc 3.9 (released Feb 4, 2026) via official amd64 deb
          PANDOC_VERSION="3.9"
          DEB_FILE="pandoc-${PANDOC_VERSION}-1-amd64.deb"  # Correct filename with -1 revision
          wget "https://github.com/jgm/pandoc/releases/download/\( {PANDOC_VERSION}/ \){DEB_FILE}"
          sudo dpkg -i "${DEB_FILE}" || sudo apt-get install -f -y  # Fix deps if needed
          rm "${DEB_FILE}"
          pandoc --version  # Debug: expect "pandoc 3.9"

          # Install latest markdownlint-cli
          npm install -g markdownlint-cli
          markdownlint --version  # Debug

      - name: Convert non-MD to Markdown & Lint
        run: |
          echo "Starting conversion and linting in frameworks/..."

          # Convert PDFs to MD (only .pdf files)
          find frameworks -type f ! -name ".*" | while read -r file; do
            if [[ "\( file" =\~ \.pdf \) ]]; then
              output="${file%.pdf}.md"
              echo "Converting PDF: $file → $output"
              pandoc "$file" -o "$output" --wrap=preserve --markdown-headings=atx || {
                echo "Pandoc failed for $file (skipping removal)"
                continue
              }
              echo "Conversion successful: $output"
              # rm "$file"  # Uncomment to delete original PDF after success
            fi
          done

          # Lint & auto-fix all MD files in frameworks/
          echo "Linting Markdown files..."
          find frameworks -type f -name "*.md" ! -name ".*" -exec markdownlint --fix {} \;
          echo "Markdown linting & auto-fixing complete."

      - name: Scan Frameworks and Update README
        run: |
          python - <<EOF
          import os
          import re

          summary_lines = ["## Frameworks Overview (Auto-generated)\n"]
          for root, dirs, files in os.walk('frameworks'):
              level = root.replace('frameworks', '').count(os.sep)
              indent = '  ' * level
              if level > 0:
                  folder_name = os.path.basename(root)
                  summary_lines.append(f"{indent}- **{folder_name}/**\n")
              for file in sorted(files):
                  if file.endswith('.md'):
                      path = os.path.join(root, file)
                      rel_path = os.path.relpath(path, '.')
                      with open(path, 'r', encoding='utf-8') as f:
                          content = f.read()
                          version_match = re.search(r'(?i)version:\s*([\d\.]+)', content)
                          version = version_match.group(1) if version_match else 'Unknown'
                      summary_lines.append(f"{indent}  - [{file}]({rel_path}) — Version {version}\n")

          summary = ''.join(summary_lines)

          readme_path = 'README.md'
          if os.path.exists(readme_path):
              with open(readme_path, 'r', encoding='utf-8') as f:
                  content = f.read()
              if '## Frameworks Overview (Auto-generated)' in content:
                  parts = content.split('## Frameworks Overview (Auto-generated)')
                  new_content = parts[0] + summary + (parts[1].split('\n', 1)[1] if len(parts) > 1 else '')
              else:
                  new_content = content.rstrip() + '\n\n' + summary
              with open(readme_path, 'w', encoding='utf-8') as f:
                  f.write(new_content)
              print("README updated with frameworks summary.")
          EOF

      - name: Commit Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Ensured Markdown structure in frameworks/ & synced README [ci skip]"
          file_pattern: "frameworks/**/*.md README.md"