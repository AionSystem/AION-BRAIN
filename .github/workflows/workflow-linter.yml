name: Workflow Linter & Auto-Fixer

on:
  pull_request:
    paths: ['**/*.yml', '**/*.yaml']
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      auto_commit:
        description: 'Auto-commit fixes (use with caution)'
        required: false
        default: 'false'
        type: choice
        options: ['true', 'false']

jobs:
  lint-and-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install linter tools
        run: |
          pip install --quiet --upgrade pip
          pip install --quiet yamllint pyyaml jsonschema
          echo "‚úÖ Installed tools"

      - name: Create yamllint config (relaxed for GitHub Actions)
        run: |
          cat > .yamllint.yml <<EOF
          extends: default

          rules:
            document-start: disable
            line-length:
              max: 160
              allow-non-breakable-words: true
              allow-non-breakable-inline-mappings: true
            truthy:
              allowed-values: ['true', 'false', 'on', 'off']  # Allow 'on' for triggers
              check-keys: false
            braces: {min-spaces-inside: 0, max-spaces-inside: 0}
            brackets: {min-spaces-inside: 0, max-spaces-inside: 0}
            comments: {min-spaces-from-content: 1}
            indentation: {spaces: consistent, indent-sequences: true}
          EOF
          echo "‚úÖ yamllint config created (relaxed)"

      - name: Lint and auto-fix workflow files
        id: yamllint
        run: |
          echo "üîß Linting & fixing .github/workflows/*.y*ml"
          EXIT_CODE=0
          shopt -s nullglob

          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            [ -f "$file" ] || continue
            echo ""
            echo "üìÑ Processing: $file"

            # Backup
            cp "$file" "$file.bak"

            # Run yamllint (parsable for logging)
            yamllint_output=$(yamllint -f parsable "$file" 2>&1) || true
            if [ -n "$yamllint_output" ]; then
              echo "  ‚ö†Ô∏è yamllint issues:"
              echo "$yamllint_output" | sed 's/^/    /'
              EXIT_CODE=1
            else
              echo "  ‚úÖ yamllint clean"
            fi

            # Auto-format with Python (add name if missing + consistent dump)
            python3 - <<'PYEOF' "$file"
          import sys
          import yaml
          import os

          path = sys.argv[1]
          try:
              with open(path, 'r', encoding='utf-8') as f:
                  data = yaml.safe_load(f) or {}

              modified = False

              # Add name if missing
              if 'name' not in data:
                  basename = os.path.basename(path).replace('.yml', '').replace('.yaml', '')
                  name = ' '.join(word.capitalize() for word in basename.replace('-', ' ').split())
                  data['name'] = name
                  modified = True
                  print(f"  Added missing 'name': {name}")

              # Dump with consistent style
              with open(path, 'w', encoding='utf-8') as f:
                  yaml.dump(data, f, default_flow_style=False, sort_keys=False,
                            width=160, allow_unicode=True, indent=2)
                  print("  Auto-formatted YAML")

          except Exception as e:
              print(f"  ‚ùå Fix failed: {e}", file=sys.stderr)
              # Restore backup on fail
              os.replace(f"{path}.bak", path)
              sys.exit(1)
          PYEOF

            if [ $? -ne 0 ]; then
              echo "  ‚ö†Ô∏è Python fix failed - restored backup"
              EXIT_CODE=1
            fi

            # Re-lint after fix
            if ! yamllint "$file" > /dev/null 2>&1; then
              echo "  ‚ùå Still fails yamllint after fix"
              EXIT_CODE=1
            fi
          done

          exit $EXIT_CODE

      - name: Schema & Structure Validation
        run: |
          echo "üîç Running schema + structure checks (combined Python)"

          python3 - <<'PYEOF'
          import os, sys, yaml, json
          from jsonschema import validate, ValidationError

          REQUIRED = ['name', 'on', 'jobs']
          ERRORS = []

          schema = {
              "type": "object",
              "required": ["name", "on", "jobs"],
              "properties": {
                  "name": {"type": "string", "minLength": 1},
                  "on": {"type": ["object", "string", "array"]},
                  "jobs": {"type": "object", "minProperties": 1}
              }
          }

          for root, _, files in os.walk('.github/workflows'):
              for file in files:
                  if not file.endswith(('.yml', '.yaml')): continue
                  path = os.path.join(root, file)
                  try:
                      with open(path) as f:
                          data = yaml.safe_load(f)
                      if not data: 
                          ERRORS.append(f"{file}: Empty")
                          continue

                      validate(data, schema)

                      for field in REQUIRED:
                          if field not in data:
                              ERRORS.append(f"{file}: Missing '{field}'")

                      if 'jobs' in data:
                          for jname, job in data['jobs'].items():
                              if 'runs-on' not in job:
                                  ERRORS.append(f"{file}: Job '{jname}' missing 'runs-on'")

                  except Exception as e:
                      ERRORS.append(f"{file}: {str(e)}")

          if ERRORS:
              print("\n".join(ERRORS))
              sys.exit(1)
          print("All workflows valid")
          PYEOF

      - name: Commit fixes (if enabled)
        if: always() && (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.auto_commit == 'true')) && !github.event.pull_request.head.repo.fork
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: auto-fix workflow YAML linting & formatting"
          file_pattern: .github/workflows/*.y*ml
          skip_dirty_check: false

      - name: Final summary
        if: always()
        run: echo "Workflow finished. Check previous steps for details."