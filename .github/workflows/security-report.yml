name: Monthly Security Report
on:
  schedule:
    - cron: '0 0 1 * *' # First day of every month
  workflow_dispatch: # Manual trigger

jobs:
  security-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: Generate Security Report
      id: security
      uses: actions/github-script@v6
      with:
        script: |
          // Get vulnerability count
          const { data: alerts } = await github.rest.dependabot.listAlertsForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open'
          });
          
          // Create report
          const report = `
          # Monthly Security Report - ${new Date().toISOString().split('T')[0]}
          
          ## Summary
          - **Open Vulnerabilities:** ${alerts.length}
          - **Critical:** ${alerts.filter(a => a.security_advisory.severity === 'critical').length}
          - **High:** ${alerts.filter(a => a.security_advisory.severity === 'high').length}
          - **Last Scan:** ${new Date().toISOString()}
          
          ## Details
          ${alerts.map(alert => `
          ### ${alert.security_advisory.summary}
          - **Package:** ${alert.dependency.package.name}
          - **Severity:** ${alert.security_advisory.severity}
          - **CVSS:** ${alert.security_advisory.cvss?.score || 'N/A'}
          - **Fix:** ${alert.security_advisory.vulnerabilities[0]?.patched_versions || 'See PR'}
          `).join('\n')}
          `;
          
          // Create file
          await github.rest.repos.createOrUpdateFileContents({
            owner: context.repo.owner,
            repo: context.repo.repo,
            path: `reports/security-${new Date().toISOString().split('-').slice(0,2).join('-')}.md`,
            message: 'Monthly security report',
            content: Buffer.from(report).toString('base64')
          });
