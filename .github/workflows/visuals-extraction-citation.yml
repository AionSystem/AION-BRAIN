name: Visual Structure Extraction and Citation (MD Only)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  extract-and-visualize:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install markdown-it-py

      - name: Scan and Generate Mermaid for Markdown Files
        run: |
          python3 - <<'EOF'
          import os
          from markdown_it import MarkdownIt

          def has_mermaid_already(content):
              return '```mermaid' in content.lower()  # Case-insensitive check

          def add_mermaid(file_path):
              try:
                  with open(file_path, 'r', encoding='utf-8') as f:
                      content = f.read()

                  if has_mermaid_already(content):
                      print(f"Skipping {file_path} â€” already has Mermaid")
                      return

                  md = MarkdownIt()
                  # Better table detection
                  has_table = '|' in content and '---' in content and content.count('|') > 20

                  if has_table:
                      mermaid = """pie title Detected Table (Placeholder)
          "Rows" : 60
          "Columns" : 40"""
                  else:
                      mermaid = """graph TD
          A[File] --> B[Headers]
          B --> C[Content]
          C --> D[Visual]"""

                  citation = f"""\n\n```mermaid
          {mermaid}
          ```

          *By Sheldon K Salmon - Source: https://github.com/AionSystem/AION-BRAIN*"""

                  with open(file_path, 'a', encoding='utf-8') as f:
                      f.write(citation)
                  print(f"Added to {file_path}")

              except Exception as e:
                  print(f"Error on {file_path}: {type(e).__name__} - {e}")

          # Process only .md files
          processed = 0
          for root, _, files in os.walk('.'):
              for file in files:
                  if file.endswith('.md') and not file.startswith('.') and 'visuals/' not in root:
                      full_path = os.path.join(root, file)
                      add_mermaid(full_path)
                      processed += 1
          print(f"Processed {processed} .md files")
          EOF

      - name: Commit Visual Updates
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-added Mermaid visuals & citations to MD [ci skip]"
          file_pattern: "*.md"