name: Workflow Linter & Auto-Fixer

on:
  pull_request:
    paths: ['**/*.yml', '**/*.yaml']
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      auto_commit:
        description: 'Auto-commit fixes (use with caution)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  lint-and-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install linter tools
        run: |
          pip install --quiet yamllint pyyaml jsonschema
          echo "‚úÖ Installed: yamllint, PyYAML, jsonschema"

      - name: Create yamllint config
        run: |
          cat > .yamllint.yml <<'EOF'
          extends: default

          rules:
            document-start: disable
            line-length:
              max: 120
              allow-non-breakable-words: true
              allow-non-breakable-inline-mappings: true
            truthy:
              check-keys: false
            braces:
              min-spaces-inside: 0
              max-spaces-inside: 0
            brackets:
              min-spaces-inside: 0
              max-spaces-inside: 0
            comments:
              min-spaces-from-content: 1
          EOF
          echo "‚úÖ yamllint config created"

      - name: Lint this workflow file first
        run: |
          echo "üîç Self-check: Validating this linter workflow..."
          if yamllint .github/workflows/workflow-linter.yml; then
            echo "‚úÖ This workflow file passes yamllint"
          else
            echo "‚ùå This workflow file has linting issues!"
            exit 1
          fi

      - name: Run yamllint with auto-fix
        id: yamllint
        continue-on-error: true
        run: |
          echo "üîß Linting workflow files..."
          shopt -s nullglob
          EXIT_CODE=0
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            [ -f "$file" ] || continue
            echo ""
            echo "üìÑ Linting: $file"
            if ! yamllint_output=$(yamllint -f parsable "$file" 2>&1); then
              echo "  ‚ö†Ô∏è  Found linting issues:"
              echo "$yamllint_output" | sed 's/^/    /'
              EXIT_CODE=1
              cp "$file" "$file.backup"
              echo "  üíæ Backup created: $file.backup"
              python3 <<'PYEOF' "$file"
          import os
          import sys
          import yaml

          file_path = sys.argv[1]

          try:
              with open(file_path, 'r') as f:
                  content = yaml.safe_load(f)

              if content:
                  if 'name' not in content:
                      basename = os.path.basename(file_path)
                      filename = (basename.replace('.yml', '')
                                         .replace('.yaml', '')
                                         .replace('-', ' ')
                                         .replace('_', ' ')
                                         .title())
                      content['name'] = filename
                      print(f"  ‚úÖ Added missing 'name' field: {filename}")

                  with open(file_path, 'w') as f:
                      yaml.dump(content, f, default_flow_style=False,
                                sort_keys=False, width=120, allow_unicode=True)

                  print(f"  ‚úÖ Auto-formatted: {file_path}")

          except Exception as e:
              print(f"  ‚ùå Could not auto-fix: {e}", file=sys.stderr)
              sys.exit(1)
          PYEOF
              if [ $? -ne 0 ]; then
                echo "  ‚ö†Ô∏è  Auto-fix failed, restoring backup"
                mv "$file.backup" "$file"
              fi
            else
              echo "  ‚úÖ No linting issues found"
            fi
          done
          exit $EXIT_CODE

      - name: Validate against JSON schema
        id: schema_validation
        continue-on-error: true
        run: |
          echo "üîç Validating workflows against schema..."
          
          # Check if schema exists first
          SCHEMA_FOUND=false
          if [ -f ".github/schemas/workflow-schema.json" ]; then
            SCHEMA_PATH=".github/schemas/workflow-schema.json"
            SCHEMA_FOUND=true
          elif [ -f ".github/schema/workflow-schema.json" ]; then
            SCHEMA_PATH=".github/schema/workflow-schema.json"
            SCHEMA_FOUND=true
          fi
          
          if [ "$SCHEMA_FOUND" = false ]; then
            echo "‚ö†Ô∏è  No schema file found at .github/schema/ or .github/schemas/"
            echo "   Creating minimal schema for validation..."
            mkdir -p .github/schemas
            cat > .github/schemas/workflow-schema.json <<'EOF'
          {
            "$schema": "http://json-schema.org/draft-07/schema#",
            "title": "GitHub Actions Workflow",
            "type": "object",
            "required": ["name", "on", "jobs"],
            "properties": {
              "name": {"type": "string", "minLength": 1},
              "on": {"type": ["object", "string", "array"]},
              "jobs": {"type": "object", "minProperties": 1}
            }
          }
          EOF
            SCHEMA_PATH=".github/schemas/workflow-schema.json"
            echo "‚úÖ Created minimal schema file at $SCHEMA_PATH"
          fi
          
          python3 <<'PYEOF'
          import os
          import sys
          import yaml
          import json
          from jsonschema import validate, ValidationError

          SCHEMA_PATH = sys.argv[1]

          try:
              with open(SCHEMA_PATH, 'r') as f:
                  schema = json.load(f)
              print(f"‚úÖ Schema loaded from {SCHEMA_PATH}")
          except FileNotFoundError:
              print(f"‚ùå Schema file not found at {SCHEMA_PATH}")
              sys.exit(0)
          except json.JSONDecodeError as e:
              print(f"‚ùå Invalid JSON in schema: {e}")
              sys.exit(1)

          ERRORS = []
          VALIDATED = 0

          workflow_dir = '.github/workflows'
          if not os.path.exists(workflow_dir):
              print(f"‚ö†Ô∏è  No {workflow_dir} directory")
              sys.exit(0)

          for file in os.listdir(workflow_dir):
              if file.endswith(('.yml', '.yaml')):
                  path = os.path.join(workflow_dir, file)

                  try:
                      with open(path, 'r') as f:
                          content = yaml.safe_load(f)

                      if not content:
                          ERRORS.append(f"{file}: Empty or invalid YAML file")
                          continue

                      try:
                          validate(instance=content, schema=schema)
                          VALIDATED += 1
                          print(f"  ‚úÖ {file}")
                      except ValidationError as e:
                          error_path = ('.'.join(str(p) for p in e.path)
                                       if e.path else 'root')
                          ERRORS.append(f"{file}: {e.message} (at: {error_path})")

                  except yaml.YAMLError as e:
                      ERRORS.append(f"{file}: YAML parsing error - {e}")
                  except Exception as e:
                      ERRORS.append(f"{file}: Unexpected error - {e}")

          print(f"\nüìä Validation Summary: {VALIDATED} passed, {len(ERRORS)} failed")

          if ERRORS:
              print("\n‚ùå SCHEMA VALIDATION ERRORS:")
              for error in ERRORS:
                  print(f"  ‚Ä¢ {error}")
              sys.exit(1)
          else:
              print("\n‚úÖ All workflow files pass schema validation")
          PYEOF "$SCHEMA_PATH"

      - name: Validate workflow structure
        id: structure_validation
        continue-on-error: true
        run: |
          echo "üîç Validating workflow structure..."
          python3 <<'PYEOF'
          import os
          import sys
          import yaml

          REQUIRED_FIELDS = ['name', 'on', 'jobs']
          ERRORS = []
          WARNINGS = []

          workflow_dir = '.github/workflows'
          if not os.path.exists(workflow_dir):
              print("‚ö†Ô∏è  No .github/workflows directory")
              sys.exit(0)

          for file in os.listdir(workflow_dir):
              if file.endswith(('.yml', '.yaml')):
                  path = os.path.join(workflow_dir, file)

                  try:
                      with open(path, 'r') as f:
                          content = yaml.safe_load(f)

                      if not content:
                          ERRORS.append(f"{file}: Empty file")
                          continue

                      for field in REQUIRED_FIELDS:
                          if field not in content:
                              msg = f"{file}: Missing required field '{field}'"
                              ERRORS.append(msg)

                      if 'jobs' in content:
                          jobs = content['jobs']
                          if not isinstance(jobs, dict) or len(jobs) == 0:
                              msg = f"{file}: 'jobs' must be a non-empty dictionary"
                              ERRORS.append(msg)
                          else:
                              for job_name, job_config in jobs.items():
                                  if not isinstance(job_config, dict):
                                      msg = f"{file}: Job '{job_name}' must be a dict"
                                      ERRORS.append(msg)
                                      continue

                                  if 'runs-on' not in job_config:
                                      msg = f"{file}: Job '{job_name}' missing 'runs-on'"
                                      ERRORS.append(msg)

                                  if 'steps' not in job_config:
                                      msg = f"{file}: Job '{job_name}' has no steps"
                                      WARNINGS.append(msg)

                      if 'on' in content:
                          on_value = content['on']
                          if isinstance(on_value, dict) and len(on_value) == 0:
                              ERRORS.append(f"{file}: 'on' triggers cannot be empty")

                  except yaml.YAMLError as e:
                      ERRORS.append(f"{file}: YAML syntax error - {e}")

          if WARNINGS:
              print("‚ö†Ô∏è  WARNINGS:")
              for warning in WARNINGS:
                  print(f"  ‚Ä¢ {warning}")

          if ERRORS:
              print("\n‚ùå VALIDATION ERRORS:")
              for error in ERRORS:
                  print(f"  ‚Ä¢ {error}")
              print("\nüí° SUGGESTED FIXES:")
              for error in ERRORS:
                  if "Missing required field 'name'" in error:
                      fix = f"  ‚Ä¢ {error}: Add 'name: \"Workflow Name\"' at the top"
                      print(fix)
                  elif "Missing required field 'on'" in error:
                      fix = f"  ‚Ä¢ {error}: Add triggers like 'on: [push]'"
                      print(fix)
                  elif "Missing required field 'jobs'" in error:
                      fix = f"  ‚Ä¢ {error}: Add 'jobs:' section with at least one job"
                      print(fix)
                  elif "missing 'runs-on'" in error:
                      fix = f"  ‚Ä¢ {error}: Add 'runs-on: ubuntu-latest' to the job"
                      print(fix)

              sys.exit(1)
          else:
              print("‚úÖ All workflow files have valid structure")
          PYEOF

      - name: Validate fixes before committing
        if: |
          steps.yamllint.outcome == 'failure' ||
          steps.schema_validation.outcome == 'failure' ||
          steps.structure_validation.outcome == 'failure'
        run: |
          echo "üîÑ Re-validating after auto-fixes..."
          shopt -s nullglob
          REVALIDATION_FAILED=false
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            [ -f "$file" ] || continue
            if ! yamllint "$file" > /dev/null 2>&1; then
              echo "‚ùå $file still has yamllint issues after auto-fix"
              REVALIDATION_FAILED=true
            fi
          done
          if [ "$REVALIDATION_FAILED" = true ]; then
            echo "‚ö†Ô∏è  Some files failed re-validation. Rolling back..."
            for backup in .github/workflows/*.backup; do
              [ -f "$backup" ] || continue
              original="${backup%.backup}"
              mv "$backup" "$original"
              echo "  ‚Ü©Ô∏è  Restored: $original"
            done
            echo "‚ùå Auto-fixes were not safe - changes rolled back"
            exit 1
          else
            echo "‚úÖ All auto-fixes validated successfully"
          fi

      - name: Cleanup backup files
        if: always()
        run: |
          shopt -s nullglob
          for backup in .github/workflows/*.backup; do
            [ -f "$backup" ] && rm "$backup" && echo "üóëÔ∏è  Removed: $backup"
          done

      - name: Determine if auto-commit is allowed
        id: auto_commit_check
        run: |
          IS_FORK="false"
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
              IS_FORK="true"
            fi
          fi
          AUTO_COMMIT_ENABLED="${{ github.event.inputs.auto_commit }}"
          if [ "$AUTO_COMMIT_ENABLED" != "true" ] && [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            AUTO_COMMIT_ENABLED="false"
          fi
          if [ "${{ github.event_name }}" = "push" ]; then
            AUTO_COMMIT_ENABLED="true"
          fi
          echo "is_fork=$IS_FORK" >> $GITHUB_OUTPUT
          echo "auto_commit_enabled=$AUTO_COMMIT_ENABLED" >> $GITHUB_OUTPUT
          echo "üîç Auto-commit check:"
          echo "  Fork PR: $IS_FORK"
          echo "  Auto-commit enabled: $AUTO_COMMIT_ENABLED"

      - name: Commit auto-fixes
        if: |
          steps.auto_commit_check.outputs.is_fork == 'false' &&
          steps.auto_commit_check.outputs.auto_commit_enabled == 'true' &&
          (steps.yamllint.outcome == 'failure' ||
          steps.schema_validation.outcome == 'failure' ||
          steps.structure_validation.outcome == 'failure')
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          if git diff --quiet .github/workflows/; then
            echo "‚úÖ No fixes needed"
          else
            git add .github/workflows/
            git commit -m "üîß Auto-fix: Workflow linting improvements

          - Applied yamllint auto-formatting
          - Fixed structural issues
          - Validated against schema

          [skip ci]"
            git push
            echo "‚úÖ Auto-fixes committed and pushed"
          fi

      - name: Create fix suggestions document
        if: failure()
        run: |
          echo "üìù Creating fix suggestions..."
          cat > fix_suggestions.md <<'EOF'
          # üîß Workflow Fix Suggestions

          Your workflow files have validation issues. Here's how to fix them:

          ## ‚ùå Common Issues & Solutions

          ### 1. Missing 'name' field
          ```yaml
          # Add this at the very top of your workflow file
          name: "Descriptive Workflow Name"
          ```

          ### 2. Missing or invalid 'on' triggers
          ```yaml
          # Simple triggers
          on: [push, pull_request]

          # Or more specific:
          on:
            push:
              branches: [main, master]
            pull_request:
              paths: ['src/**']
            workflow_dispatch:  # Manual trigger
          ```

          ### 3. Missing 'jobs' section
          ```yaml
          jobs:
            build:
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@v4
                - run: echo "Hello World"
          ```

          ### 4. Job missing 'runs-on'
          ```yaml
          jobs:
            my-job:
              runs-on: ubuntu-latest  # ‚Üê Required!
              steps:
                - run: echo "test"
          ```

          ### 5. Heredoc indentation rules
          ```yaml
          # Heredoc closers (EOF, PYEOF) must have ZERO indentation
          run: |
            cat > file.txt <<'EOF'
          line 1
          line 2
          EOF
            # ‚Üë NO spaces before EOF
          ```

          ## üîç Schema Validation
          Your workflows are validated against .github/schema/workflow-schema.json or .github/schemas/workflow-schema.json.

          ## üìö Resources
          - [GitHub Actions Syntax](https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions)
          - [yamllint Documentation](https://yamllint.readthedocs.io/)
          EOF
          echo "‚úÖ Fix suggestions created"

      - name: Upload fix suggestions
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: fix-suggestions
          path: fix_suggestions.md
          retention-days: 30

      - name: Comment on PR with suggestions
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let suggestions = '## ‚ö†Ô∏è Workflow Validation Failed\n\n';
            suggestions += '**Auto-fixes are not enabled for fork PRs for ';
            suggestions += 'security reasons.**\n\n';
            try {
              const fixContent = fs.readFileSync('fix_suggestions.md', 'utf8');
              suggestions += fixContent;
            } catch (e) {
              suggestions += 'Some workflow files have validation issues. ';
              suggestions += 'Check the workflow run for details.\n';
            }
            suggestions += '\n\n---\n';
            suggestions += 'üí° **Tip**: Download the `fix-suggestions` artifact ';
            suggestions += 'from the workflow run for detailed guidance.';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: suggestions
            });

      - name: Set final status
        if: always()
        run: |
          echo "üìä Workflow Linter Summary"
          echo "=========================="
          echo "yamllint: ${{ steps.yamllint.outcome }}"
          echo "Schema validation: ${{ steps.schema_validation.outcome }}"
          echo "Structure validation: ${{ steps.structure_validation.outcome }}"
          echo ""
          if [ "${{ steps.yamllint.outcome }}" = "success" ] && \
             [ "${{ steps.schema_validation.outcome }}" = "success" ] && \
             [ "${{ steps.structure_validation.outcome }}" = "success" ]; then
            echo "‚úÖ All validations passed!"
            exit 0
          else
            echo "‚ùå Some validations failed - review the logs above"
            exit 1
          fi