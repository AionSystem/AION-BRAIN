name: Schema Enforcer
on:
  pull_request:
    paths: ['**/*.yml', '**/*.yaml']
  push:
    branches: [main, master]
    paths: ['**/*.yml', '**/*.yaml']

jobs:
  validate-workflows:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install validation tools
        run: pip install jsonschema pyyaml
      
      - name: Validate YAML workflows
        run: |
          echo "üîç Validating workflow files..."
          python << 'EOF'
          import os, json, yaml, sys
          from jsonschema import validate, ValidationError
          from pathlib import Path
          
          # Load workflow schema
          schema_path = Path('.github/schemas/workflow-schema.json')
          with open(schema_path) as f:
              workflow_schema = json.load(f)
          
          errors = []
          validated = 0
          
          # Only validate workflow files in .github/workflows/
          for yaml_file in Path('.github/workflows').rglob('*.yml'):
              try:
                  with open(yaml_file) as f:
                      content = yaml.safe_load(f)
                  
                  # Validate against schema
                  validate(instance=content, schema=workflow_schema)
                  print(f"‚úÖ {yaml_file}")
                  validated += 1
                  
              except yaml.YAMLError as e:
                  errors.append(f"{yaml_file}: YAML syntax error - {e}")
              except ValidationError as e:
                  errors.append(f"{yaml_file}: Schema violation - {e.message}")
              except Exception as e:
                  errors.append(f"{yaml_file}: Unexpected error - {e}")
          
          # Report results
          if errors:
              print(f"\n‚ùå Found {len(errors)} error(s) in {validated} workflow file(s):")
              for error in errors:
                  print(f"  - {error}")
              sys.exit(1)
          else:
              print(f"\n‚úÖ All {validated} workflow files passed schema validation")
          EOF