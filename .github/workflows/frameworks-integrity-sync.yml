name: Framework Integrity and README Sync

on:
  push:
    paths: ['frameworks/**', 'README.md']
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC
  workflow_dispatch:

jobs:
  validate-and-sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install tools (Pandoc 3.9 + markdownlint)
        run: |
          set -euo pipefail

          echo "=== Installing Pandoc 3.9 (Feb 2026 release) ==="
          PANDOC_VERSION="3.9"
          DEB_FILE="pandoc-3.9-1-amd64.deb"  # EXACT filename from release
          DEB_URL="https://github.com/jgm/pandoc/releases/download/\( {PANDOC_VERSION}/ \){DEB_FILE}"

          echo "Downloading from: ${DEB_URL}"
          if ! wget --no-verbose "${DEB_URL}"; then
            echo "wget failed — likely 404 or network issue. Check filename/URL."
            exit 1
          fi

          echo "Installing deb package..."
          sudo dpkg -i "${DEB_FILE}" || {
            echo "dpkg failed — fixing dependencies..."
            sudo apt-get update
            sudo apt-get install -f -y
          }
          rm -f "${DEB_FILE}"

          # Verify
          if ! command -v pandoc &> /dev/null; then
            echo "ERROR: pandoc command not found after install!"
            exit 1
          fi
          pandoc --version | head -n 3 || echo "pandoc --version failed"

          echo "=== Installing markdownlint ==="
          npm install -g markdownlint-cli
          markdownlint --version || echo "markdownlint install issue"

      - name: Convert non-MD to Markdown & Lint
        run: |
          set -euo pipefail

          echo "Scanning for PDFs in frameworks/..."

          CONVERTED=false
          find frameworks -type f ! -name ".*" | while read -r file; do
            if [[ "\( file" =\~ \.pdf \) ]]; then
              output="${file%.pdf}.md"
              echo "Converting: $file → $output"
              if pandoc "$file" -o "$output" --wrap=preserve --markdown-headings=atx --standalone; then
                echo "Success: $output"
                CONVERTED=true
                # rm "$file"  # Uncomment ONLY after testing (backs up originals!)
              else
                echo "Conversion failed for $file — skipping removal"
              fi
            fi
          done

          if ! $CONVERTED; then
            echo "No PDFs converted — proceeding to lint existing MD."
          fi

          echo "Linting & fixing MD files..."
          find frameworks -type f -name "*.md" ! -name ".*" -exec markdownlint --fix {} \; || echo "Lint fixes had issues (non-fatal)"

      - name: Scan Frameworks and Update README
        run: |
          python3 - <<EOF
          import os
          import re

          print("Building frameworks summary...")

          summary_lines = ["## Frameworks Overview (Auto-generated)\n"]
          for root, dirs, files in os.walk('frameworks'):
              level = root.replace('frameworks', '').count(os.sep)
              indent = '  ' * level
              if level > 0:
                  folder_name = os.path.basename(root)
                  summary_lines.append(f"{indent}- **{folder_name}/**\n")
              for file in sorted(files):
                  if file.endswith('.md'):
                      path = os.path.join(root, file)
                      rel_path = os.path.relpath(path, '.')
                      try:
                          with open(path, 'r', encoding='utf-8') as f:
                              content = f.read()
                          version_match = re.search(r'(?i)version:\s*([\d\.]+)', content)
                          version = version_match.group(1) if version_match else 'Unknown'
                          summary_lines.append(f"{indent}  - [{file}]({rel_path}) — Version {version}\n")
                      except Exception as e:
                          print(f"Warning reading {path}: {e}")

          summary = ''.join(summary_lines)

          readme_path = 'README.md'
          if os.path.exists(readme_path):
              with open(readme_path, 'r', encoding='utf-8') as f:
                  content = f.read()
              if '## Frameworks Overview (Auto-generated)' in content:
                  parts = content.split('## Frameworks Overview (Auto-generated)', 1)
                  new_content = parts[0] + summary + (parts[1].split('\n', 1)[1] if len(parts) > 1 else '')
              else:
                  new_content = content.rstrip() + '\n\n' + summary
              with open(readme_path, 'w', encoding='utf-8') as f:
                  f.write(new_content)
              print("README updated.")
          else:
              print("No README.md — skipping.")
          EOF

      - name: Commit Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Ensured Markdown structure in frameworks/ & synced README [ci skip]"
          file_pattern: "frameworks/**/*.md README.md"